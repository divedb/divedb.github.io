---
date: 2025-07-27
layout: post
title: BPFç®€ä»‹ã€ç¬¬ä¸€ç« ã€‘
categories: Linux
tags: [Linux, BPF] 

---

`BPF`æœ€åˆä½œä¸ºä¸€ç§ç½‘ç»œæ•°æ®åŒ…è¿‡æ»¤å™¨è€Œè¯ç”Ÿï¼Œä½†åœ¨`Linux`å†…æ ¸çš„ä¸æ–­å‘å±•ä¸­ï¼Œæ¼”å˜ä¸ºä¸€ç§é€šç”¨çš„å†…æ ¸æ‰§è¡Œå¼•æ“ï¼Œå…·å¤‡å®‰å…¨ã€å¯ç¼–ç¨‹ã€æ€§èƒ½å¼€é”€ä½ç­‰ä¼˜åŠ¿ã€‚ç°ä»£`BPF`ï¼ˆå¸¸ç§°ä¸º`eBPF`ï¼‰å·²å¹¿æ³›åº”ç”¨äºä»¥ä¸‹åœºæ™¯ï¼š

-   ç³»ç»Ÿæ€§èƒ½åˆ†æä¸æ•…éšœæ’æŸ¥ï¼ˆå¦‚`bpftrace, perf, BCC`å·¥å…·ï¼‰ã€‚
-   ç½‘ç»œç›‘æ§ä¸å®‰å…¨ï¼ˆå¦‚`Cilium, XDP`ï¼‰ã€‚
-   å†…æ ¸è¡Œä¸ºè§‚æµ‹ä¸åŠ¨æ€æ‰©å±•ï¼ˆå¦‚`tracepoints, kprobes, uprobes`ç­‰ï¼‰ã€‚

<!--more-->

##### ğŸŒ² ä»€ä¹ˆæ˜¯`Tracing`ï¼ˆè¿½è¸ªï¼‰ã€`Snooping`ï¼ˆç›‘å¬ï¼‰ã€`Sampling`ï¼ˆé‡‡æ ·ï¼‰ã€`Profiling`ï¼ˆæ€§èƒ½åˆ†æï¼‰ä¸ `Observability`ï¼ˆå¯è§‚æµ‹æ€§ï¼‰ï¼Ÿ

è¿™äº›æœ¯è¯­éƒ½ç”¨äºå¯¹åˆ†ææŠ€æœ¯ä¸å·¥å…·è¿›è¡Œåˆ†ç±»ã€‚

`Tracing`æ˜¯ä¸€ç§åŸºäºäº‹ä»¶çš„è®°å½•æ–¹å¼â€”â€”è¿™ä¹Ÿæ˜¯`BPF`å·¥å…·æ‰€é‡‡ç”¨çš„æ’æ¡©ç±»å‹ã€‚ä½ å¯èƒ½å·²ç»ä½¿ç”¨è¿‡ä¸€äº›ä¸“ç”¨çš„è¿½è¸ªå·¥å…·ã€‚æ¯”å¦‚ `Linux`çš„`strace(1)`ï¼Œå®ƒå¯ä»¥è®°å½•å¹¶æ‰“å°ç³»ç»Ÿè°ƒç”¨äº‹ä»¶ã€‚è¿˜æœ‰è®¸å¤šå·¥å…·å¹¶ä¸è¿½è¸ªäº‹ä»¶ï¼Œè€Œæ˜¯é€šè¿‡å›ºå®šçš„ç»Ÿè®¡è®¡æ•°å™¨æ¥æµ‹é‡äº‹ä»¶å¹¶æ‰“å°æ±‡æ€»ä¿¡æ¯ï¼Œä¾‹å¦‚`Linux`çš„`top(1)`å°±æ˜¯ä¸€ä¸ªä¾‹å­ã€‚

>ä¹Ÿå°±æ˜¯è¯´ï¼Œ`top`å¹¶ä¸åƒ`strace`ã€`perf`ã€æˆ–`BPF`å·¥å…·é‚£æ ·æ³¨å†Œé’©å­æ¥ç›‘å¬ç‰¹å®šäº‹ä»¶çš„å‘ç”Ÿï¼Œè€Œæ˜¯å‘¨æœŸæ€§åœ°è¯»å–`/proc`æ–‡ä»¶ç³»ç»Ÿä¸­çš„ä¿¡æ¯ï¼Œæ¯”å¦‚ï¼š
>
>-   `/proc/stat`
>-   `/proc/[pid]/stat`
>-   `/proc/meminfo`
>-   `/proc/loadavg`
>
>é€šè¿‡æ¯”è¾ƒå½“å‰è½®è¯¢ä¸ä¸Šä¸€æ¬¡è½®è¯¢ä¹‹é—´çš„æ•°å€¼å˜åŒ–ï¼Œ`top`è®¡ç®—å‡º`CPU`å ç”¨ç‡ã€å†…å­˜ä½¿ç”¨ã€è¿›ç¨‹çŠ¶æ€ç­‰ã€‚

è¿½è¸ªå™¨çš„ä¸€å¤§ç‰¹ç‚¹æ˜¯èƒ½å¤Ÿè®°å½•åŸå§‹äº‹ä»¶åŠå…¶å…ƒæ•°æ®ã€‚è¿™ç±»æ•°æ®é€šå¸¸éå¸¸åºå¤§ï¼Œå› æ­¤å¯èƒ½éœ€è¦è¿›è¡ŒåæœŸå¤„ç†ä»¥ç”Ÿæˆæ±‡æ€»ä¿¡æ¯ã€‚å€ŸåŠ©`BPF`æ‰€å®ç°çš„å¯ç¼–ç¨‹è¿½è¸ªå™¨ï¼Œå¯ä»¥åœ¨äº‹ä»¶å‘ç”Ÿæ—¶è¿è¡Œå°å‹ç¨‹åºï¼ŒåŠ¨æ€ç”Ÿæˆè‡ªå®šä¹‰çš„ç»Ÿè®¡æ±‡æ€»æˆ–æ‰§è¡Œå…¶ä»–æ“ä½œï¼Œä»è€Œé¿å…æ˜‚è´µçš„åæœŸå¤„ç†å¼€é”€ã€‚

è™½ç„¶`strace(1)`åå­—ä¸­æœ‰`trace`å­—æ ·ï¼Œä½†å¹¶éæ‰€æœ‰è¿½è¸ªå™¨çš„åå­—éƒ½å¦‚æ­¤ã€‚æ¯”å¦‚`tcpdump(8)`å°±æ˜¯ä¸€ä¸ªä¸“ç”¨äºç½‘ç»œæ•°æ®åŒ…çš„è¿½è¸ªå·¥å…·ã€‚ï¼ˆä¹Ÿè®¸å®ƒæœ¬è¯¥å«åš`tcptrace`ï¼Ÿï¼‰`Solaris`æ“ä½œç³»ç»Ÿä¸­æœ‰ä¸ªç±»ä¼¼äº`tcpdump`çš„å·¥å…·ï¼Œåä¸º`snoop(1M)`ï¼Œä¹‹æ‰€ä»¥å« `snoop`ï¼Œæ˜¯å› ä¸ºå®ƒç”¨äºç›‘å¬ç½‘ç»œæ•°æ®åŒ…ã€‚æˆ‘æ›¾åœ¨`Solaris`ä¸Šå¼€å‘å¹¶å‘å¸ƒäº†è®¸å¤šè¿½è¸ªå·¥å…·ï¼Œå½“æ—¶ï¼ˆä¹Ÿè®¸æ˜¯ä¸ªé”™è¯¯ï¼‰é‡‡ç”¨äº† `snooping`è¿™ä¸€æœ¯è¯­ï¼Œç”¨æ¥å‘½åæ—©æœŸå·¥å…·ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆç°åœ¨æœ‰`execsnoop(8)`ã€`opensnoop(8)`ã€`biosnoop(8)`ç­‰ç­‰ã€‚`Snooping`ã€äº‹ä»¶è½¬å‚¨ï¼ˆ`event dumping`ï¼‰ä¸`tracing`é€šå¸¸æ˜¯æŒ‡åŒä¸€ç§æ“ä½œã€‚åç»­ç« èŠ‚ä¼šè¯¦ç»†ä»‹ç»è¿™äº›å·¥å…·ã€‚

é™¤äº†å·¥å…·åç§°ä»¥å¤–ï¼Œ`tracing`è¿™ä¸ªæœ¯è¯­åœ¨å†…æ ¸å¼€å‘è€…ä¸­ä¹Ÿè¢«å¹¿æ³›ä½¿ç”¨ï¼Œå°¤å…¶æ˜¯å½“è°ˆè®ºä½¿ç”¨`BPF`è¿›è¡Œå¯è§‚æµ‹æ€§åˆ†ææ—¶ã€‚

`Sampling`å·¥å…·åˆ™æ˜¯ä»å¤§é‡æµ‹é‡æ•°æ®ä¸­æå–éƒ¨åˆ†æ ·æœ¬ï¼Œä»¥ä¾¿ç²—ç•¥å‹¾å‹’å‡ºç›®æ ‡ç³»ç»Ÿçš„çŠ¶å†µï¼›è¿™ç±»æ–¹æ³•ä¹Ÿç§°ä¸ºåˆ›å»º`profile`ï¼ˆæ€§èƒ½ç”»åƒï¼‰æˆ–`profiling`ï¼ˆæ€§èƒ½åˆ†æï¼‰ã€‚`BPF`å·¥å…·ä¸­æœ‰ä¸€ä¸ªåä¸º`profile(8)`çš„å·¥å…·ï¼Œå®ƒé€šè¿‡å®šæ—¶å™¨å¯¹è¿è¡Œä¸­çš„ä»£ç è¿›è¡Œé‡‡æ ·ã€‚ä¾‹å¦‚ï¼Œå®ƒå¯ä»¥æ¯10æ¯«ç§’é‡‡æ ·ä¸€æ¬¡ï¼Œæ¢å¥è¯è¯´ï¼Œå°±æ˜¯æ¯ç§’ï¼ˆåœ¨æ¯ä¸ª`CPU`ä¸Šï¼‰é‡‡é›†100ä¸ªæ ·æœ¬ã€‚é‡‡æ ·å™¨çš„ä¸€ä¸ªä¼˜ç‚¹æ˜¯æ€§èƒ½å¼€é”€å¯èƒ½ä½äºè¿½è¸ªå™¨ï¼Œå› ä¸ºå®ƒä»¬åªæµ‹é‡æ‰€æœ‰äº‹ä»¶ä¸­çš„ä¸€å°éƒ¨åˆ†ã€‚ä½†ç¼ºç‚¹æ˜¯é‡‡æ ·åªèƒ½æä¾›ç²—ç•¥çš„ç³»ç»Ÿè§†å›¾ï¼Œå¹¶å¯èƒ½æ¼æ‰æŸäº›äº‹ä»¶ã€‚

`Observability`æŒ‡çš„æ˜¯é€šè¿‡è§‚å¯Ÿæ¥ç†è§£ç³»ç»Ÿè¡Œä¸ºï¼Œå®ƒä¹Ÿç”¨æ¥ç»Ÿç§°é‚£äº›å®ç°è¿™ä¸€ç›®çš„çš„å·¥å…·ã€‚è¿™äº›å·¥å…·åŒ…æ‹¬è¿½è¸ªå·¥å…·ã€é‡‡æ ·å·¥å…·ä»¥åŠåŸºäºå›ºå®šè®¡æ•°å™¨çš„å·¥å…·ã€‚ä½†ä¸åŒ…æ‹¬åŸºå‡†æµ‹è¯•å·¥å…·ï¼ˆ`benchmark tools`ï¼‰ï¼Œå› ä¸ºåè€…é€šè¿‡æ‰§è¡Œå·¥ä½œè´Ÿè½½å®éªŒæ¥æ”¹å˜ç³»ç»ŸçŠ¶æ€ã€‚

##### ğŸŒ² ä»€ä¹ˆæ˜¯`BCC`ã€`bpftrace`å’Œ`IO Visor`ï¼Ÿ

ç›´æ¥ç¼–å†™`BPF`æŒ‡ä»¤æå…¶ç¹çï¼Œå› æ­¤å‡ºç°äº†ä¸€äº›å‰ç«¯å·¥å…·ï¼Œæä¾›æ›´é«˜çº§çš„è¯­è¨€æ¥å£æ¥ç®€åŒ–å¼€å‘ã€‚ç”¨äºè¿½è¸ªä»»åŠ¡çš„ä¸»è¦å‰ç«¯`BCC`å’Œ`bpftrace`ã€‚

![](/assets/img/linux/bpf/figure1-1.png)

`BCCï¼ˆBPF Compiler Collectionï¼‰`æ˜¯ç¬¬ä¸€ä¸ªä¸º`BPF`å¼€å‘çš„é«˜çº§è¿½è¸ªæ¡†æ¶ã€‚å®ƒæä¾›ä¸€ä¸ªç”¨äºç¼–å†™å†…æ ¸`BPF`ç¨‹åºçš„`C`è¯­è¨€ç¯å¢ƒï¼Œä»¥åŠç”¨äºç”¨æˆ·æ€äº¤äº’çš„å¤šç§è¯­è¨€æ¥å£ï¼Œå¦‚`Python`ã€`Lua`å’Œ`C++`ã€‚`BCC`ä¹Ÿæ˜¯`libbcc`å’Œç°ä»Šå¹¿æ³›ä½¿ç”¨çš„`libbpf`åº“çš„èµ·ç‚¹ï¼Œè¿™äº›åº“æä¾›äº†åœ¨å†…æ ¸äº‹ä»¶ä¸Šæ’æ¡©ï¼ˆ`instrumentation`ï¼‰å¹¶åŠ è½½`BPF`ç¨‹åºçš„åŠŸèƒ½ã€‚`BCC`ä»“åº“ä¸­è¿˜åŒ…å«70å¤šä¸ªç°æˆçš„`BPF`å·¥å…·ï¼Œç”¨äºæ€§èƒ½åˆ†æä¸æ•…éšœæ’æŸ¥ã€‚ä½ å¯ä»¥ç›´æ¥å®‰è£…`BCC`å¹¶è¿è¡Œè¿™äº›å·¥å…·ï¼Œè€Œæ— éœ€è‡ªå·±ç¼–å†™ä»»ä½•`BCC`ä»£ç ã€‚æœ¬ä¹¦å°†å¸¦ä½ é€æ­¥äº†è§£å…¶ä¸­çš„å¤šä¸ªå·¥å…·ã€‚

`bpftrace`æ˜¯ä¸€ä¸ªè¾ƒæ–°çš„å‰ç«¯ï¼Œæä¾›äº†ä¸“é—¨ä¸º`BPF`è®¾è®¡çš„é«˜çº§é¢†åŸŸç‰¹å®šè¯­è¨€ï¼ˆ`DSL`ï¼‰ã€‚`bpftrace`çš„ä»£ç éå¸¸ç®€æ´ï¼Œå› æ­¤æœ¬ä¹¦é€šå¸¸ä¼šç›´æ¥å±•ç¤ºå·¥å…·çš„æºç ï¼Œä»¥ä¾¿è¯´æ˜å®ƒä»¬æ˜¯å¦‚ä½•æ’æ¡©å¹¶å¤„ç†äº‹ä»¶çš„ã€‚`bpftrace`æ„å»ºäº`libbcc`ä¸`libbpf`ä¹‹ä¸Šã€‚

å¦‚å›¾1-1æ‰€ç¤ºï¼Œ`BCC`ä¸`bpftrace`æ˜¯äº’è¡¥çš„ï¼š

-   `bpftrace`é€‚ç”¨äºå¼ºå¤§çš„â€œä¸€è¡Œå‘½ä»¤â€å’Œå°è„šæœ¬çš„å¿«é€Ÿå¼€å‘ï¼›
-   `BCC`æ›´é€‚åˆæ„å»ºå¤æ‚çš„è„šæœ¬æˆ–å¸¸é©»åå°çš„æœåŠ¡ç¨‹åºï¼Œå¹¶ä¸”å¯ä»¥é›†æˆå…¶ä»–è¯­è¨€åº“ã€‚ä¾‹å¦‚ï¼Œè®¸å¤š`Python`ç¼–å†™çš„`BCC`å·¥å…·ä½¿ç”¨äº† `Python`çš„ `argparse` åº“ï¼Œä»¥å®ç°å¯¹å‘½ä»¤è¡Œå‚æ•°çš„å¤æ‚æ§åˆ¶ã€‚

å¦ä¸€ä¸ª`BPF`å‰ç«¯å·¥å…·`ply`ä¹Ÿæ­£åœ¨å¼€å‘ä¸­ï¼Œå®ƒçš„è®¾è®¡ç›®æ ‡æ˜¯è½»é‡ã€ä¾èµ–æœ€å°‘ï¼Œéå¸¸é€‚åˆåµŒå…¥å¼`Linux`ç¯å¢ƒã€‚å¦‚æœ`ply`æ›´é€‚åˆä½ çš„ä½¿ç”¨åœºæ™¯ï¼Œæœ¬ä¹¦ä¾ç„¶å…·æœ‰æŒ‡å¯¼ä»·å€¼â€”â€”ä¹¦ä¸­å±•ç¤ºçš„`bpftrace`å·¥å…·å¤§å¤šæ•°éƒ½å¯ä»¥åœ¨è½¬æ¢ä¸º`ply`è¯­æ³•åè¿è¡Œã€‚ï¼ˆæœªæ¥çš„`ply`ç‰ˆæœ¬å¯èƒ½ç›´æ¥æ”¯æŒ`bpftrace`è¯­æ³•ã€‚ï¼‰
æœ¬ä¹¦èšç„¦äº`bpftrace`ï¼Œæ˜¯å› ä¸ºå…¶å‘å±•æ›´ä¸ºæˆç†Ÿï¼Œå¹¶å…·å¤‡å…¨é¢çš„åŠŸèƒ½ï¼Œèƒ½å¤Ÿèƒœä»»æ‰€æœ‰çš„`BPF`åˆ†æä»»åŠ¡ã€‚

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ`BCC`ä¸`bpftrace`å¹¶ä¸å±äº`Linux`å†…æ ¸æºç çš„ä¸€éƒ¨åˆ†ï¼Œè€Œæ˜¯ç”±`Linux`åŸºé‡‘ä¼šæ——ä¸‹çš„ä¸€ä¸ª`GitHub`é¡¹ç›®â€”â€”`IO Visor`æ‰€ç»´æŠ¤ã€‚é¡¹ç›®åœ°å€å¦‚ä¸‹ï¼š

-   https://github.com/iovisor/bcc
-   https://github.com/iovisor/bpftrace

åœ¨æœ¬ä¹¦ä¸­ï¼Œ`BPF tracing`ä¸€è¯é€šå¸¸æ³›æŒ‡ä½¿ç”¨`BCC`æˆ–`bpftrace`å·¥å…·è¿›è¡Œçš„è¿½è¸ªåˆ†æã€‚

##### ğŸŒ² åˆè¯†`BCC`ï¼šå¿«é€Ÿä¸Šæ‰‹

è®©æˆ‘ä»¬ç›´æ¥è¿›å…¥æ­£é¢˜ï¼Œé€šè¿‡ä¸€äº›å·¥å…·è¾“å‡ºå¿«é€Ÿæ„Ÿå—`BCC`çš„å¨åŠ›ã€‚ä¸‹é¢è¿™ä¸ªå·¥å…·ç”¨äºè¿½è¸ªæ–°è¿›ç¨‹çš„å¯åŠ¨ï¼Œå¹¶åœ¨æ¯ä¸ªè¿›ç¨‹å¯åŠ¨æ—¶æ‰“å°ä¸€è¡Œç®€è¦ä¿¡æ¯ã€‚

è¿™ä¸ªå·¥å…·åä¸º`execsnoop(8)`ï¼Œæ¥`BCC`å·¥å…·é›†ã€‚å®ƒçš„å·¥ä½œåŸç†æ˜¯è¿½è¸ª`execve(2)`ç³»ç»Ÿè°ƒç”¨ï¼Œè€Œè¿™ä¸ªç³»ç»Ÿè°ƒç”¨æ­£æ˜¯`exec(2)`ç³»åˆ—çš„ä¸€ç§å˜ä½“ï¼ˆå·¥å…·åä¸­çš„`exec`å³ç”±æ­¤è€Œæ¥ï¼‰ã€‚

å¦‚ä½•å®‰è£…`BCC`å·¥å…·å°†åœ¨ç¬¬4ç« ä¸­ä»‹ç»ï¼Œåç»­ç« èŠ‚ä¹Ÿä¼šé€æ­¥è®²è§£è¿™äº›å·¥å…·çš„åŸç†ä¸ç”¨æ³•ã€‚

```bash
$ sudo apt install bpfcc-tools linux-headers-$(uname -r)
$ sudo execsnoop-bpfcc
In file included from <built-in>:2:
In file included from /virtual/include/bcc/bpf.h:12:
In file included from include/linux/types.h:6:
In file included from include/uapi/linux/types.h:14:
In file included from include/uapi/linux/posix_types.h:5:
In file included from include/linux/stddef.h:5:
In file included from include/uapi/linux/stddef.h:5:
In file included from include/linux/compiler_types.h:148:
include/linux/compiler-clang.h:45:9: warning: '__HAVE_BUILTIN_BSWAP32__' macro redefined [-Wmacro-redefined]
#define __HAVE_BUILTIN_BSWAP32__
        ^
<command line>:4:9: note: previous definition is here
#define __HAVE_BUILTIN_BSWAP32__ 1
        ^
In file included from <built-in>:2:
In file included from /virtual/include/bcc/bpf.h:12:
In file included from include/linux/types.h:6:
In file included from include/uapi/linux/types.h:14:
In file included from include/uapi/linux/posix_types.h:5:
In file included from include/linux/stddef.h:5:
In file included from include/uapi/linux/stddef.h:5:
In file included from include/linux/compiler_types.h:148:
include/linux/compiler-clang.h:46:9: warning: '__HAVE_BUILTIN_BSWAP64__' macro redefined [-Wmacro-redefined]
#define __HAVE_BUILTIN_BSWAP64__
        ^
<command line>:5:9: note: previous definition is here
#define __HAVE_BUILTIN_BSWAP64__ 1
        ^
In file included from <built-in>:2:
In file included from /virtual/include/bcc/bpf.h:12:
In file included from include/linux/types.h:6:
In file included from include/uapi/linux/types.h:14:
In file included from include/uapi/linux/posix_types.h:5:
In file included from include/linux/stddef.h:5:
In file included from include/uapi/linux/stddef.h:5:
In file included from include/linux/compiler_types.h:148:
include/linux/compiler-clang.h:47:9: warning: '__HAVE_BUILTIN_BSWAP16__' macro redefined [-Wmacro-redefined]
#define __HAVE_BUILTIN_BSWAP16__
        ^
<command line>:3:9: note: previous definition is here
#define __HAVE_BUILTIN_BSWAP16__ 1
        ^
3 warnings generated.
PCOMM            PID    PPID   RET ARGS
```

è¾“å‡ºç»“æœå±•ç¤ºåœ¨è¿½è¸ªæœŸé—´å“ªäº›è¿›ç¨‹è¢«æ‰§è¡Œäº†â€”â€”å…¶ä¸­æœ‰äº›è¿›ç¨‹å¯èƒ½éå¸¸çŸ­æš‚ï¼Œä»¥è‡³äºåœ¨å…¶ä»–å·¥å…·ä¸­æ ¹æœ¬çœ‹ä¸åˆ°ã€‚ä½ ä¼šçœ‹åˆ°å¤§é‡è¾“å‡ºè¡Œï¼Œæ˜¾ç¤ºçš„æ˜¯ä¸€äº›æ ‡å‡†çš„`Unix`å·¥å…·ï¼Œå¦‚`ps(1)`ã€`grep(1)`ã€`sed(1)`ã€`cut(1)`ç­‰ã€‚

å¯ä»¥ä½¿ç”¨`execsnoop(8)`çš„`-t`é€‰é¡¹æ¥ä¸ºè¾“å‡ºæ·»åŠ ä¸€ä¸ªæ—¶é—´æˆ³åˆ—ï¼Œä»è€Œæ›´æ¸…æ¥šåœ°çœ‹åˆ°äº‹ä»¶å‘ç”Ÿçš„æ—¶é—´é¡ºåºã€‚

```bash
$ sudo biolatency-bpfcc -m
In file included from <built-in>:2:
In file included from /virtual/include/bcc/bpf.h:12:
In file included from include/linux/types.h:6:
In file included from include/uapi/linux/types.h:14:
In file included from include/uapi/linux/posix_types.h:5:
In file included from include/linux/stddef.h:5:
In file included from include/uapi/linux/stddef.h:5:
In file included from include/linux/compiler_types.h:148:
include/linux/compiler-clang.h:45:9: warning: '__HAVE_BUILTIN_BSWAP32__' macro redefined [-Wmacro-redefined]
#define __HAVE_BUILTIN_BSWAP32__
        ^
<command line>:4:9: note: previous definition is here
#define __HAVE_BUILTIN_BSWAP32__ 1
        ^
In file included from <built-in>:2:
In file included from /virtual/include/bcc/bpf.h:12:
In file included from include/linux/types.h:6:
In file included from include/uapi/linux/types.h:14:
In file included from include/uapi/linux/posix_types.h:5:
In file included from include/linux/stddef.h:5:
In file included from include/uapi/linux/stddef.h:5:
In file included from include/linux/compiler_types.h:148:
include/linux/compiler-clang.h:46:9: warning: '__HAVE_BUILTIN_BSWAP64__' macro redefined [-Wmacro-redefined]
#define __HAVE_BUILTIN_BSWAP64__
        ^
<command line>:5:9: note: previous definition is here
#define __HAVE_BUILTIN_BSWAP64__ 1
        ^
In file included from <built-in>:2:
In file included from /virtual/include/bcc/bpf.h:12:
In file included from include/linux/types.h:6:
In file included from include/uapi/linux/types.h:14:
In file included from include/uapi/linux/posix_types.h:5:
In file included from include/linux/stddef.h:5:
In file included from include/uapi/linux/stddef.h:5:
In file included from include/linux/compiler_types.h:148:
include/linux/compiler-clang.h:47:9: warning: '__HAVE_BUILTIN_BSWAP16__' macro redefined [-Wmacro-redefined]
#define __HAVE_BUILTIN_BSWAP16__
        ^
<command line>:3:9: note: previous definition is here
#define __HAVE_BUILTIN_BSWAP16__ 1
        ^
3 warnings generated.
cannot attach kprobe, Invalid argument
Traceback (most recent call last):
  File "/usr/sbin/biolatency-bpfcc", line 147, in <module>
    b.attach_kprobe(event="blk_account_io_done",
  File "/usr/lib/python3/dist-packages/bcc/__init__.py", line 683, in attach_kprobe
    raise Exception("Failed to attach BPF program %s to kprobe %s" %
Exception: Failed to attach BPF program b'trace_req_done' to kprobe b'blk_account_io_done'
```

ğŸ” å¯èƒ½åŸå› ä¸è§£å†³æ–¹æ¡ˆ

-   å†…æ ¸ç‰ˆæœ¬å’Œå†…æ ¸ç¬¦å·åä¸åŒ¹é…

    `blk_account_io_done`æ˜¯ä¸€ä¸ªå†…æ ¸å‡½æ•°åï¼Œ`biolatency`å·¥å…·éœ€è¦åœ¨å†…æ ¸ä¸­æ‰¾åˆ°è¿™ä¸ªç¬¦å·å¹¶é™„åŠ æ¢é’ˆã€‚
    å¦‚æœä½ çš„å†…æ ¸ç‰ˆæœ¬å’Œ`BCC`å·¥å…·è®¾è®¡æ—¶é¢„æœŸçš„å†…æ ¸ç‰ˆæœ¬å·®å¼‚è¾ƒå¤§ï¼Œæˆ–è€…å†…æ ¸é…ç½®ä¸æ”¯æŒè¯¥æ¢é’ˆï¼Œå¯èƒ½ä¼šæ‰¾ä¸åˆ°è¯¥ç¬¦å·æˆ–å‚æ•°ä¸å…¼å®¹ã€‚

-   ç¼ºå°‘å†…æ ¸è°ƒè¯•ç¬¦å·

    æŸäº›å†…æ ¸æ¨¡å—æˆ–å†…æ ¸ç¼ºå°‘è°ƒè¯•ç¬¦å·ï¼Œå¯¼è‡´æ¢é’ˆæ— æ³•æ­£ç¡®é™„åŠ ã€‚

-   å†…æ ¸å®‰å…¨é™åˆ¶ï¼ˆæ¯”å¦‚ç¦æ­¢`kprobe`ï¼‰

    æŸäº›å‘è¡Œç‰ˆæˆ–è€…å†…æ ¸é…ç½®ä¸ºäº†å®‰å…¨ï¼Œå¯èƒ½ç¦æ­¢`kprobe`æˆ–é™åˆ¶`BPF`ç¨‹åºé™„åŠ ã€‚

å…·ä½“æ’æŸ¥å»ºè®®

-   **ç¡®è®¤å†…æ ¸ç‰ˆæœ¬**

```bash
$ uname -r
```

ç¡®è®¤æ˜¯å¦ä¸ºä¸»æµæ”¯æŒç‰ˆæœ¬ï¼ˆå¦‚`5.x`æˆ–`6.x`ç³»åˆ—ï¼‰ã€‚å¦‚æœæ˜¯è¾ƒæ–°å†…æ ¸ï¼Œå¯èƒ½`BCC`çš„æ—§ç‰ˆå·¥å…·å­˜åœ¨å…¼å®¹é—®é¢˜ã€‚

-   **æŸ¥çœ‹å†…æ ¸ç¬¦å·**

```bash
$ sudo cat /proc/kallsyms | grep blk_account_io_done
```

å¦‚æœæ²¡æœ‰è¾“å‡ºï¼Œè¯´æ˜å†…æ ¸ä¸­æ²¡æœ‰å¯¼å‡ºè¯¥ç¬¦å·ï¼Œ`kprobe`å°±æ— æ³•é™„åŠ ã€‚

-   å‡çº§`BCC`å’Œå†…æ ¸å¤´æ–‡ä»¶

ç¡®ä¿`BCC`å’Œå†…æ ¸å¤´æ–‡ä»¶ç‰ˆæœ¬åŒ¹é…ï¼Œå¹¶ä¸”æ˜¯æœ€æ–°ç‰ˆæœ¬ã€‚

```bash
$ sudo apt update
$ sudo apt upgrade bpfcc-tools linux-headers-$(uname -r)
```

-   å°è¯•ä½¿ç”¨`bpftrace`ç‰ˆæœ¬

`bpftrace`æœ‰æ—¶èƒ½æ›´å¥½å…¼å®¹æ–°å†…æ ¸ï¼š

```bash
$ sudo bpftrace -e 'kprobe:blk_account_io_done { @[comm] = hist(nsecs / 1000); }'
```

##### ğŸŒ² `BPF`è·Ÿè¸ªçš„å¯è§æ€§

`BPF`è·Ÿè¸ªæä¾›äº†å¯¹æ•´ä¸ªè½¯ä»¶æ ˆçš„å¯è§‚æµ‹æ€§ï¼Œå¹¶å…è®¸ä½ æŒ‰éœ€åˆ›å»ºæ–°çš„å·¥å…·å’Œç›‘æ§æ‰‹æ®µã€‚ä½ å¯ä»¥ç›´æ¥åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨`BPF`è·Ÿè¸ªï¼Œæ— éœ€é‡å¯ç³»ç»Ÿï¼Œä¹Ÿæ— éœ€ä»¥ç‰¹æ®Šæ¨¡å¼é‡å¯åº”ç”¨ç¨‹åºã€‚

è¿™å°±åƒæ‹¥æœ‰äº†â€œ`X`å…‰è§†é‡â€ï¼šå½“ä½ éœ€è¦æ·±å…¥æŸ¥çœ‹æŸä¸ªå†…æ ¸ç»„ä»¶ã€è®¾å¤‡æˆ–åº”ç”¨ç¨‹åºåº“æ—¶ï¼Œ`BPF`è®©ä½ èƒ½å¤Ÿä»¥å‰æ‰€æœªæœ‰çš„æ–¹å¼è¿›è¡Œå®æ—¶ã€åœ¨çº¿çš„è§‚å¯Ÿã€‚

ä¸ºäº†è¯´æ˜è¿™ä¸€ç‚¹ï¼Œå›¾1-2å±•ç¤ºäº†ä¸€ä¸ªé€šç”¨ç³»ç»Ÿè½¯ä»¶æ ˆçš„ç»“æ„ï¼Œæˆ‘åœ¨å…¶ä¸Šæ ‡æ³¨äº†å¯ç”¨äºè§‚å¯Ÿå„ä¸ªç»„ä»¶çš„åŸºäº`BPF`çš„æ€§èƒ½åˆ†æå·¥å…·ã€‚è¿™äº›å·¥å…·æ¥è‡ª`BCC`ã€`bpftrace`ä»¥åŠæœ¬ä¹¦çš„å†…å®¹ï¼Œå…¶ä¸­å¾ˆå¤šå°†åœ¨åç»­ç« èŠ‚ä¸­è¯¦ç»†ä»‹ç»ã€‚

![](/assets/img/linux/bpf/figure1-2.png)

æƒ³æƒ³çœ‹ï¼Œä½ é€šå¸¸ä¼šä½¿ç”¨å“ªäº›å·¥å…·æ¥åˆ†æè¯¸å¦‚å†…æ ¸çš„`CPU`è°ƒåº¦å™¨ã€è™šæ‹Ÿå†…å­˜ã€æ–‡ä»¶ç³»ç»Ÿç­‰ç»„ä»¶ã€‚åªéœ€æµè§ˆè¿™å¼ å›¾ï¼Œä½ æˆ–è®¸å°±èƒ½å‘ç°è¿‡å»éš¾ä»¥è§‚å¯Ÿçš„â€œç›²åŒºâ€ï¼Œè€Œç°åœ¨å¯ä»¥é€šè¿‡`BPF`å·¥å…·æ¥è·å–å¯è§æ€§ã€‚

è¿™äº›ä¼ ç»Ÿå·¥å…·åŠå…¶å¯¹ä¸åŒç»„ä»¶çš„è§‚æµ‹èƒ½åŠ›åœ¨è¡¨1-1ä¸­è¿›è¡Œäº†æ€»ç»“ï¼Œå¹¶æ ‡æ˜äº†`BPF`è·Ÿè¸ªæ˜¯å¦ä¹Ÿèƒ½ç”¨äºè¿™äº›ç»„ä»¶çš„åˆ†æã€‚ä¼ ç»Ÿå·¥å…·ä»ç„¶æ˜¯æ€§èƒ½åˆ†æçš„è‰¯å¥½èµ·ç‚¹ï¼Œä½ å¯ä»¥å…ˆç”¨å®ƒä»¬è¿›è¡Œåˆæ­¥è°ƒæŸ¥ï¼Œç„¶åå†å€ŸåŠ©`BPF`è·Ÿè¸ªå·¥å…·æ·±å…¥æ¢ç´¢ã€‚

è¡¨1-1ï¼šä¼ ç»Ÿåˆ†æå·¥å…·

| `Components`                                                 | `Traditional Analysis Tools`    | `BPF Tracing`               |
| ------------------------------------------------------------ | ------------------------------- | --------------------------- |
| `Applications with language runtimes: Java, Node.js, Ruby, PHP` | `Runtime debuggers`             | `Yes, with runtime support` |
| `Applications using compiled code: C, C++, Golang`           | `System debuggers`              | `Yes`                       |
| `System libraries: /lib/*`                                   | `ltrace(1)`                     | `Yes`                       |
| `System call interface`                                      | `strace(1), perf(1)`            | `Yes`                       |
| `Kernel: Scheduler, file systems, TCP , IP , etc`            | `Ftrace, perf(1) for sampling ` | `Yes, in more detail`       |
| `Hardware: CPU internals, devices`                           | `perf, sar, /proc counters`     | `Yes, direct or indirect`   |

##### ğŸŒ² åŠ¨æ€æ’æ¡©ï¼š`kprobes`å’Œ`uprobes`

`BPF`è·Ÿè¸ªæ”¯æŒå¤šç§äº‹ä»¶æ¥æºï¼Œä»è€Œå®ç°å¯¹æ•´ä¸ªè½¯ä»¶æ ˆçš„å¯è§‚æµ‹æ€§ã€‚å…¶ä¸­å€¼å¾—ç‰¹åˆ«æåŠçš„æ˜¯**åŠ¨æ€æ’æ¡©**ï¼ˆä¹Ÿç§°ä¸ºåŠ¨æ€è·Ÿè¸ªï¼‰ï¼šå³åœ¨è¿è¡Œä¸­çš„è½¯ä»¶ä¸ŠåŠ¨æ€æ’å…¥è§‚æµ‹ç‚¹çš„èƒ½åŠ›ï¼Œç”šè‡³å¯ä»¥ç›´æ¥åœ¨ç”Ÿäº§ç¯å¢ƒä¸­å®Œæˆã€‚è¿™ç§æ–¹å¼åœ¨ä¸ä½¿ç”¨æ—¶**ä¸ä¼šå¸¦æ¥ä»»ä½•è¿è¡Œå¼€é”€**ï¼Œå› ä¸ºè½¯ä»¶æœ¬èº«æ— éœ€ä¿®æ”¹ã€‚`BPF`å·¥å…·å¸¸å¸¸ä½¿ç”¨è¿™ç§æ–¹å¼å¯¹å†…æ ¸å‡½æ•°å’Œç”¨æˆ·åº”ç”¨å‡½æ•°çš„èµ·å§‹å’Œç»“æŸä½ç½®è¿›è¡Œæ’æ¡©â€”â€”è¿™äº›å‡½æ•°åœ¨ä¸€ä¸ªå…¸å‹çš„è½¯ä»¶æ ˆä¸­å¾€å¾€æˆåƒä¸Šä¸‡ã€‚å€ŸåŠ©è¿™ç§æŠ€æœ¯ï¼Œè·å–çš„å¯è§æ€§ä¹‹æ·±ä¸å…¨é¢ï¼Œå‡ ä¹å¯ä»¥è¯´æ˜¯ä¸€ç§â€œè¶…èƒ½åŠ›â€ã€‚

åŠ¨æ€æ’æ¡©æŠ€æœ¯æœ€æ—©å‡ºç°åœ¨1990å¹´ä»£[Hollingsworth 94]ï¼Œçµæ„Ÿæ¥è‡ªè°ƒè¯•å™¨é€šè¿‡åœ¨æŒ‡ä»¤åœ°å€å¤„æ’å…¥æ–­ç‚¹çš„æŠ€æœ¯ã€‚ä¸è°ƒè¯•å™¨ä¸åŒçš„æ˜¯ï¼ŒåŠ¨æ€æ’æ¡©å…è®¸ç›®æ ‡è½¯ä»¶åœ¨è®°å½•å¿…è¦ä¿¡æ¯å**è‡ªåŠ¨ç»§ç»­æ‰§è¡Œ**ï¼Œè€Œä¸æ˜¯äº¤ç»™äº¤äº’å¼è°ƒè¯•å™¨æ¥ç®¡ã€‚å½“æ—¶ä¹Ÿå‡ºç°äº†é…å¥—çš„åŠ¨æ€è·Ÿè¸ªå·¥å…·ï¼ˆå¦‚kerninst [Tamches 99]ï¼‰ï¼Œå¹¶é…æœ‰ä¸“ç”¨çš„è·Ÿè¸ªè¯­è¨€ï¼Œä½†è¿™äº›å·¥å…·å§‹ç»ˆè¾ƒä¸ºå†·é—¨ã€ä½¿ç”¨ç‡ä½ã€‚å…¶ä¸­ä¸€ä¸ªåŸå› æ˜¯**é£é™©è¾ƒé«˜**ï¼šåŠ¨æ€è·Ÿè¸ªä¼šåœ¨è¿è¡Œæ—¶ä¿®æ”¹è¿›ç¨‹æˆ–å†…æ ¸çš„æŒ‡ä»¤ï¼Œä¸€æ—¦å‡ºé”™ï¼Œå¯èƒ½ä¼šç«‹å³å¯¼è‡´å†…å­˜æŸåæˆ–ç¨‹åº/å†…æ ¸å´©æºƒã€‚

`Linux`ä¸Šçš„åŠ¨æ€æ’æ¡©æœ€æ—©ç”±`IBM`å›¢é˜Ÿåœ¨2000å¹´å¼€å‘ï¼Œåä¸º`DProbes`ï¼Œä½†è¯¥è¡¥ä¸é›†è¢«å†…æ ¸ç¤¾åŒºæ‹’ç»é‡‡çº³ã€‚ç›´åˆ°2004å¹´ï¼Œ`Linux`æ‰æ­£å¼å¼•å…¥åŸºäº`DProbes`çš„å†…æ ¸å‡½æ•°åŠ¨æ€æ’æ¡©æœºåˆ¶â€”â€”`kprobes`ã€‚ä¸è¿‡æ­¤æ—¶çš„`kprobes`ä¾ç„¶åæ°”ä¸å¤§ï¼Œä½¿ç”¨ä¹Ÿæ¯”è¾ƒå¤æ‚ã€‚

çœŸæ­£çš„è½¬æŠ˜ç‚¹å‘ç”Ÿåœ¨2005å¹´ï¼Œ`Sun Microsystems`æ¨å‡ºäº†è‡ªå·±çš„åŠ¨æ€è·Ÿè¸ªç³»ç»Ÿ`DTrace`ï¼Œé…å¥—æœ‰æ˜“ç”¨çš„`D`è¯­è¨€ï¼Œå¹¶å°†å…¶é›†æˆè¿› `Solaris 10`æ“ä½œç³»ç»Ÿã€‚`Solaris`ä¸€ç›´ä»¥ç”Ÿäº§ç¯å¢ƒçš„ç¨³å®šæ€§è‘—ç§°ï¼Œè€Œ`DTrace`ä½œä¸ºé»˜è®¤è½¯ä»¶åŒ…éšç³»ç»Ÿå‘å¸ƒï¼Œå‘ä¸šç•Œè¯æ˜äº†åŠ¨æ€è·Ÿè¸ªåœ¨ç”Ÿäº§ç¯å¢ƒä¸­æ˜¯å¯è¡Œä¸”å®‰å…¨çš„ã€‚è¿™ä¸€äº‹ä»¶æˆä¸ºè¯¥æŠ€æœ¯å‘å±•çš„é‡Œç¨‹ç¢‘ã€‚æˆ‘æœ¬äººä¹Ÿå‘è¡¨äº†å¤§é‡ä»‹ç»`DTrace`çš„æ–‡ç« ï¼Œæ„å»ºå¹¶å‘å¸ƒäº†è®¸å¤š`DTrace`å·¥å…·ã€‚`Sun`çš„å¸‚åœºã€é”€å”®å’Œæ•™è‚²éƒ¨é—¨éƒ½ç§¯ææ¨å¹¿è¿™é¡¹æŠ€æœ¯ï¼Œç”šè‡³å°†`DTrace`çº³å…¥`Solaris`çš„æ ‡å‡†åŸ¹è®­è¯¾ç¨‹ã€‚è¿™äº›åŠªåŠ›ä¿ƒä½¿åŠ¨æ€æ’æ¡©ä»å°ä¼—æŠ€æœ¯ä¸€è·ƒæˆä¸ºè¢«å¹¿æ³›è®¤å¯ä¸”å¤‡å—å…³æ³¨çš„èƒ½åŠ›ã€‚

`Linux`åœ¨2012å¹´åŠ å…¥äº†ç”¨æˆ·æ€å‡½æ•°çš„åŠ¨æ€æ’æ¡©æœºåˆ¶ï¼Œç§°ä¸º`uprobes`ã€‚`BPF`è·Ÿè¸ªå·¥å…·ç°å·²æ”¯æŒä½¿ç”¨`kprobes`å’Œ`uprobes`å¯¹æ•´ä¸ªè½¯ä»¶æ ˆè¿›è¡ŒåŠ¨æ€æ’æ¡©ã€‚

ä¸ºäº†æ›´ç›´è§‚åœ°å±•ç¤ºåŠ¨æ€è·Ÿè¸ªçš„ç”¨æ³•ï¼Œè¡¨1-2ç»™å‡ºäº†å‡ ä¸ªä½¿ç”¨`bpftrace`æŒ‡å®šæ¢é’ˆçš„ä¾‹å­ï¼Œè¿™äº›æ¢é’ˆåŸºäº`kprobes`å’Œ`uprobes`ã€‚

è¡¨1-2ï¼š`bpftrace`ä¸­`kprobe`å’Œ`uprobe`ç¤ºä¾‹

| æ¢é’ˆ                           | æè¿°                                        |
| ------------------------------ | ------------------------------------------- |
| `kprobe:vfs_read`              | æ’æ¡©å†…æ ¸å‡½æ•°`vfs_read()`çš„å¼€å§‹ä½ç½®          |
| `kretprobe:vfs_read`           | æ’æ¡©å†…æ ¸å‡½æ•°`vfs_read()`çš„è¿”å›ç‚¹            |
| `uprobe:/bin/bash:readline`    | æ’æ¡©`/bin/bash`ä¸­`readline()`å‡½æ•°çš„å¼€å§‹ä½ç½® |
| `uretprobe:/bin/bash:readline` | æ’æ¡©`/bin/bash`ä¸­`readline()`å‡½æ•°çš„è¿”å›ç‚¹   |

##### ğŸŒ² é™æ€æ’æ¡©ï¼š`Tracepoints`ä¸`USDT`

åŠ¨æ€æ’æ¡©è™½ç„¶å¼ºå¤§ï¼Œä½†ä¹Ÿå­˜åœ¨ä¸€äº›ç¼ºç‚¹ï¼šå®ƒä¾èµ–çš„å‡½æ•°å¯èƒ½åœ¨ä¸åŒç‰ˆæœ¬çš„è½¯ä»¶ä¸­è¢«é‡å‘½åæˆ–ç§»é™¤ï¼Œè¿™å°±æ˜¯æ‰€è°“çš„â€œæ¥å£ç¨³å®šæ€§é—®é¢˜â€ã€‚ä¸€æ—¦ä½ å‡çº§äº†å†…æ ¸æˆ–åº”ç”¨ç¨‹åºï¼Œå¯èƒ½ä¼šå‘ç°åŸæœ¬å¯ç”¨çš„`BPF`å·¥å…·çªç„¶æ— æ³•æ­£å¸¸å·¥ä½œâ€”â€”è¦ä¹ˆæŠ¥é”™æ— æ³•æ‰¾åˆ°å‡½æ•°è¿›è¡Œæ’æ¡©ï¼Œè¦ä¹ˆå¹²è„†æ²¡æœ‰ä»»ä½•è¾“å‡ºã€‚å¦ä¸€ä¸ªé—®é¢˜æ˜¯ï¼šå‡ºäºä¼˜åŒ–ç›®çš„ï¼Œç¼–è¯‘å™¨å¯èƒ½ä¼šå°†å‡½æ•°å†…è”ï¼ˆ`inline`ï¼‰ï¼Œè¿™æ ·å°±æ— æ³•å†é€šè¿‡`kprobes`æˆ–`uprobes`å¯¹è¿™äº›å‡½æ•°è¿›è¡Œæ’æ¡©ã€‚

ä¸ºäº†è§£å†³ä¸Šè¿°æ¥å£ä¸ç¨³å®šå’Œå‡½æ•°å†…è”çš„é—®é¢˜ï¼Œ**é™æ€æ’æ¡©**æˆä¸ºäº†ä¸€ä¸ªæ›´å¯é çš„æ–¹æ¡ˆã€‚å®ƒé€šè¿‡åœ¨è½¯ä»¶ä¸­åµŒå…¥ç¨³å®šçš„äº‹ä»¶åï¼Œç”±å¼€å‘è€…è´Ÿè´£ç»´æŠ¤ã€‚`BPF`è·Ÿè¸ªæ”¯æŒå†…æ ¸é™æ€æ’æ¡©ï¼ˆ`tracepoints`ï¼‰å’Œç”¨æˆ·æ€é™æ€æ’æ¡©ï¼ˆ`USDT`ï¼Œ`User-level Statically Defined Tracing`ï¼‰ã€‚ä¸è¿‡ï¼Œé™æ€æ’æ¡©çš„ç¼ºç‚¹æ˜¯å¢åŠ äº†å¼€å‘è€…çš„ç»´æŠ¤è´Ÿæ‹…ï¼Œå› æ­¤å¤§å¤šæ•°è½¯ä»¶åªæä¾›æœ‰é™æ•°é‡çš„é™æ€æ’æ¡©ç‚¹ã€‚

å¦‚æœä½ æ‰“ç®—å¼€å‘è‡ªå·±çš„`BPF`å·¥å…·ï¼Œè¿™äº›ç»†èŠ‚æ‰æ˜¯ä½ éœ€è¦å…³å¿ƒçš„ã€‚å»ºè®®çš„ç­–ç•¥æ˜¯ï¼š**ä¼˜å…ˆå°è¯•ä½¿ç”¨é™æ€æ’æ¡©ï¼ˆtracepoints å’Œ USDTï¼‰**ï¼Œåªæœ‰åœ¨æ— æ³•æ»¡è¶³éœ€æ±‚æ—¶å†è€ƒè™‘ä½¿ç”¨åŠ¨æ€æ’æ¡©ï¼ˆ`kprobes`å’Œ`uprobes`ï¼‰ã€‚

ä¸‹è¡¨å±•ç¤ºäº†`bpftrace`ä¸­ä½¿ç”¨`tracepoints`å’Œ`USDT`è¿›è¡Œé™æ€æ’æ¡©çš„ç¤ºä¾‹ï¼š

è¡¨ 1-3ï¼š`bpftrace`çš„`tracepoint`å’Œ`USDT`ç¤ºä¾‹

| æ¢é’ˆç±»å‹ä¸åç§°                             | æè¿°                                         |
| ------------------------------------------ | -------------------------------------------- |
| `tracepoint:syscalls:sys_enter_open`       | æ’æ¡©`open(2)`ç³»ç»Ÿè°ƒç”¨                        |
| `usdt:/usr/sbin/mysqld:mysql:query__start` | æ’æ¡©`/usr/sbin/mysqld`ä¸­çš„`query__start`æ¢é’ˆ |

ğŸ” æœ¬è´¨åŒºåˆ«ä¸€ï¼šæ’æ¡©æ—¶æœºä¸åŒ

| ç±»å‹     | æ’æ¡©æ—¶æœº                     | è¯´æ˜                                             |
| -------- | ---------------------------- | ------------------------------------------------ |
| é™æ€æ’æ¡© | å¼€å‘é˜¶æ®µï¼Œå†™åœ¨æºä»£ç æˆ–æ±‡ç¼–ä¸­ | ç”±ç¨‹åºå‘˜æˆ–ç¼–è¯‘å™¨åœ¨**ç¼–è¯‘æ—¶æˆ–é“¾æ¥æ—¶**å°±æ˜ç¡®æ’å¥½   |
| åŠ¨æ€æ’æ¡© | è¿è¡Œæ—¶ï¼ˆ`Run-time`ï¼‰         | åœ¨ç¨‹åºè¿è¡ŒæœŸé—´**åŠ¨æ€åœ°ä¿®æ”¹**æŒ‡ä»¤æˆ–å†…å­˜ä»¥æ·»åŠ æ¢é’ˆ |

ğŸ§  æœ¬è´¨åŒºåˆ«äºŒï¼šæ˜¯å¦éœ€è¦ä¿®æ”¹ç¨‹åºæœ¬ä½“

| ç±»å‹     | æ˜¯å¦ä¿®æ”¹åŸç¨‹åº               | ç¨³å®šæ€§                         | çµæ´»æ€§                      |
| -------- | ---------------------------- | ------------------------------ | --------------------------- |
| é™æ€æ’æ¡© | æ˜¯ï¼Œæ’æ¡©å†™æ­»åœ¨ç¨‹åºé‡Œ         | é«˜ï¼šæ¥å£ç¨³å®šã€å…¼å®¹å‡çº§         | ä½ï¼šä¸å®¹æ˜“ä¿®æ”¹æˆ–æ‰©å±•        |
| åŠ¨æ€æ’æ¡© | å¦ï¼Œè¿è¡Œæ—¶æ’å…¥ï¼Œç¨‹åºæœ¬ä½“ä¸å˜ | ä½ï¼šæ¥å£ä¸ç¨³å®šï¼Œå‡çº§åå¯èƒ½å¤±æ•ˆ | é«˜ï¼šå¯æ ¹æ®éœ€æ±‚åŠ¨æ€æ·»åŠ /ç§»é™¤ |

##### ğŸŒ² åˆè¯†`bpftrace`ï¼šè·Ÿè¸ª`open()`

æˆ‘ä»¬æ¥å†™ä¸€ä¸ªç®€å•çš„`bpftrace`ç¨‹åºï¼Œç”¨äºè·Ÿè¸ª`open(2)`ç³»ç»Ÿè°ƒç”¨ã€‚å†…æ ¸å·²ç»ä¸ºå…¶æä¾›äº†ä¸€ä¸ª`tracepoint`ï¼ˆ`syscalls:sys_enter_open`ï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥åœ¨å‘½ä»¤è¡Œæ‰§è¡Œï¼š

```bash
# bpftrace -e 'tracepoint:syscalls:sys_enter_open { printf("%s %s\n", comm, str(args->filename)); }'
```

ä½ ç°åœ¨ä¸éœ€è¦ç†è§£è¿™ä¸€è¡Œä»£ç çš„å…·ä½“å«ä¹‰ï¼Œ`bpftrace`çš„è¯­æ³•ä¸å®‰è£…å°†åœ¨ç¬¬5ç« è¯¦ç»†ä»‹ç»ã€‚ä¸è¿‡ï¼Œå³ä½¿ä¸äº†è§£è¯­æ³•ï¼Œä¹Ÿè®¸ä½ èƒ½å¤§è‡´çŒœåˆ°è¿™ä¸ªç¨‹åºçš„ä½œç”¨â€”â€”è¿™è¯´æ˜è¯­è¨€æœ¬èº«æ˜¯ç›´è§‚ä¸”æ˜“ç”¨çš„ã€‚ç°åœ¨è¯·ä½ ä¸“æ³¨äºè¾“å‡ºç»“æœï¼š

```bash
Attaching 1 probe...
slack /run/user/1000/gdm/Xauthority
slack /run/user/1000/gdm/Xauthority
slack /run/user/1000/gdm/Xauthority
slack /run/user/1000/gdm/Xauthority
^C
```

è¾“å‡ºç»“æœæ˜¾ç¤ºäº†è°ƒç”¨`open(2)`ç³»ç»Ÿè°ƒç”¨çš„è¿›ç¨‹åï¼ˆå¦‚`slack`ï¼‰ï¼Œä»¥åŠå…¶å°è¯•æ‰“å¼€çš„æ–‡ä»¶è·¯å¾„ã€‚å› ä¸º`bpftrace`æ˜¯**ç³»ç»ŸèŒƒå›´å†…è·Ÿè¸ª**ï¼Œæ‰€ä»¥ä»»ä½•è°ƒç”¨`open(2)`çš„è¿›ç¨‹éƒ½ä¼šè¢«è®°å½•ã€‚æ¯ä¸€è¡Œè¡¨ç¤ºä¸€ä¸ªç³»ç»Ÿè°ƒç”¨äº‹ä»¶ï¼Œæ˜¯å…¸å‹çš„â€œæ¯äº‹ä»¶ä¸€è¡Œâ€é£æ ¼çš„å·¥å…·ã€‚

`BPF`è·Ÿè¸ªä¸ä»…é€‚ç”¨äºæœåŠ¡å™¨åˆ†æï¼Œæˆ‘å†™è¿™æœ¬ä¹¦æ—¶å°±åœ¨ç¬”è®°æœ¬ä¸Šè¿è¡Œå®ƒï¼Œçœ‹åˆ°çš„æ˜¯`Slack`èŠå¤©ç¨‹åºæ­£åœ¨æ‰“å¼€çš„æ–‡ä»¶ã€‚

è¿™ä¸ªå°ç¨‹åºå®šä¹‰åœ¨å•å¼•å·ä¸­çš„ä¸€è¡Œå†…ï¼ŒæŒ‰ä¸‹å›è½¦åå³è¢«ç¼–è¯‘æ‰§è¡Œã€‚`bpftrace`ä¼šæ¿€æ´»`open(2)`çš„`tracepoint`ï¼›å½“ä½ æŒ‰ä¸‹`Ctrl-C`åœæ­¢ç¨‹åºæ—¶ï¼Œè¯¥`tracepoint`ä¼šè¢«å¸è½½ï¼Œå°ç¨‹åºä¹Ÿéšä¹‹è¢«ç§»é™¤ã€‚è¿™å°±æ˜¯`BPF`è·Ÿè¸ªå·¥å…·æŒ‰éœ€å¯ç”¨çš„æ–¹å¼ï¼š**å·¥å…·åªåœ¨å‘½ä»¤è¿è¡ŒæœŸé—´å¤„äºæ¿€æ´»çŠ¶æ€**ï¼Œå¯ä»¥çŸ­è‡³å‡ ç§’ã€‚

ä¸è¿‡ï¼Œè¿™æ¬¡çš„è¾“å‡ºæ¯”æˆ‘é¢„æœŸçš„å°‘ï¼Œå¯èƒ½æœ‰äº›`open(2)`è°ƒç”¨æ²¡è¢«è·Ÿè¸ªåˆ°ã€‚å†…æ ¸ä¸­å…¶å®è¿˜æœ‰å¤šä¸ª`open`å˜ä½“ï¼Œæˆ‘åˆšæ‰åªè·Ÿè¸ªäº†å…¶ä¸­ä¸€ä¸ªã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡é€šé…ç¬¦åˆ—å‡ºæ‰€æœ‰ç›¸å…³`tracepoints`ï¼š

```bash
# bpftrace -l 'tracepoint:syscalls:sys_enter_open*'
tracepoint:syscalls:sys_enter_open_by_handle_at
tracepoint:syscalls:sys_enter_open
tracepoint:syscalls:sys_enter_openat
```

ç°åœ¨çœ‹æ¥ï¼Œç°ä»£ç³»ç»Ÿä¸­æ›´å¤šä½¿ç”¨çš„æ˜¯`openat(2)`ã€‚æˆ‘ç”¨å¦ä¸€ä¸ª`bpftrace`ä¸€è¡Œå¼æ¥ç¡®è®¤ï¼š

```bash
# bpftrace -e 'tracepoint:syscalls:sys_enter_open* { @[probe] = count(); }'
Attaching 3 probes...
^C
@[tracepoint:syscalls:sys_enter_open]: 5
@[tracepoint:syscalls:sys_enter_openat]: 308
```

è™½ç„¶è¿™æ®µä»£ç çš„å…·ä½“æœºåˆ¶æˆ‘ä»¬ä¼šåœ¨ç¬¬5ç« å†è®²ï¼Œä½†ä½ ç°åœ¨åªéœ€çœ‹æ‡‚è¾“å‡ºç»“æœï¼šå®ƒç»Ÿè®¡äº†æ¯ä¸ª`tracepoint`çš„è°ƒç”¨æ¬¡æ•°ã€‚ç»“æœè¯´æ˜ï¼šåœ¨è¿™æ®µè·Ÿè¸ªæœŸé—´ï¼Œ`openat(2)`è¢«è°ƒç”¨äº†308æ¬¡ï¼Œè€Œ`open(2)`ä»…æœ‰5æ¬¡ã€‚è¿™äº›è®¡æ•°éƒ½æ˜¯ç”±å†…æ ¸ä¸­çš„`BPF`ç¨‹åºé«˜æ•ˆå®Œæˆçš„ã€‚

å¦‚æœæˆ‘æƒ³åŒæ—¶è¿½è¸ª`open(2)`å’Œ`openat(2)`ï¼Œå¯ä»¥æŠŠä¸¤ä¸ª`tracepoint`éƒ½åŠ è¿›ä¸€è¡Œå¼ä»£ç ä¸­ã€‚ä½†è¿™æ ·å‘½ä»¤ä¼šå˜å¾—å†—é•¿ï¼Œä¸å¦‚ç›´æ¥å†™æˆè„šæœ¬ä¿å­˜ä¸‹æ¥ï¼Œæ–¹ä¾¿ç¼–è¾‘ã€‚äº‹å®ä¸Šï¼Œ`bpftrace`å·²ç»ä¸ºä½ å‡†å¤‡å¥½äº†è¿™æ ·çš„å·¥å…·è„šæœ¬ï¼š

```bash
# opensnoop.bt
Attaching 3 probes...
Tracing open syscalls... Hit Ctrl-C to end.
PID   COMM       FD ERR PATH
2440  snmp-pass   4   0  /proc/cpuinfo
2440  snmp-pass   4   0  /proc/stat
25706 ls          3   0  /etc/ld.so.cache
25706 ls          3   0  /lib/x86_64-linux-gnu/libselinux.so.1
25706 ls          3   0  /lib/x86_64-linux-gnu/libc.so.6
25706 ls          3   0  /lib/x86_64-linux-gnu/libpcre.so.3
25706 ls          3   0  /lib/x86_64-linux-gnu/libdl.so.2
25706 ls          3   0  /lib/x86_64-linux-gnu/libpthread.so.0
25706 ls          3   0  /proc/filesystems
25706 ls          3   0  /usr/lib/locale/locale-archive
25706 ls          3   0  .
1744  snmpd       8   0  /proc/net/dev
1744  snmpd      -1   2  /sys/class/net/lo/device/vendor
2440  snmp-pass   4   0  /proc/cpuinfo
^C
```

è¯¥è¾“å‡ºä»¥åˆ—å½¢å¼å±•ç¤ºï¼šè¿›ç¨‹`ID`ï¼ˆ`PID`ï¼‰ã€å‘½ä»¤åï¼ˆ`COMM`ï¼‰ã€æ–‡ä»¶æè¿°ç¬¦ï¼ˆ`FD`ï¼‰ã€é”™è¯¯ç ï¼ˆ`ERR`ï¼‰ã€æ–‡ä»¶è·¯å¾„ï¼ˆ`PATH`ï¼‰ã€‚`opensnoop.bt`å¯ç”¨äºï¼š

-   æ’æŸ¥ç¨‹åºä¸ºä»€ä¹ˆæ— æ³•æ‰“å¼€æ–‡ä»¶ï¼ˆä¾‹å¦‚è·¯å¾„é”™è¯¯ï¼‰ï¼›
-   æŸ¥æ‰¾é…ç½®æ–‡ä»¶æˆ–æ—¥å¿—æ–‡ä»¶çš„å®é™…è·¯å¾„ï¼›
-   å‘ç°æ€§èƒ½é—®é¢˜ï¼Œæ¯”å¦‚æ–‡ä»¶è¢«è¿‡äºé¢‘ç¹åœ°æ‰“å¼€ï¼Œæˆ–è€…åå¤æŸ¥æ‰¾é”™è¯¯ä½ç½®ã€‚

è¿™æ˜¯ä¸€ä¸ªéå¸¸å®ç”¨çš„å·¥å…·ã€‚

`bpftrace`è‡ªå¸¦äº†20å¤šä¸ªç±»ä¼¼çš„ç°æˆå·¥å…·ï¼Œè€Œ`BCC`æä¾›çš„å·¥å…·æ•°é‡è¶…è¿‡70ä¸ªã€‚é™¤äº†èƒ½ç›´æ¥å¸®ä½ è§£å†³é—®é¢˜ï¼Œè¿™äº›å·¥å…·çš„æºç ä¹Ÿå±•ç¤ºäº†å¦‚ä½•è¿½è¸ªä¸åŒç›®æ ‡ã€‚å°±åƒåˆšæ‰è¿½è¸ª`open(2)`æ—¶é‡åˆ°çš„é—®é¢˜ï¼Œå®ƒä»¬çš„æºç å¾€å¾€ä¹ŸåŒ…å«äº†è§£å†³æ–¹æ¡ˆã€‚

##### å›åˆ°`BCC`ï¼šè¿½è¸ª`open()`

ç°åœ¨æˆ‘ä»¬æ¥çœ‹çœ‹ä½¿ç”¨`BCC`å®ç°çš„`opensnoop(8)`å·¥å…·ï¼š

```bash
# opensnoop
PID 	COMM           	FD 	ERR PATH
2262 	DNS Res~er #657 22  0   /etc/hosts
2262 	DNS Res~er #654 178 0   /etc/hosts
29588 device poll    	4  	0   /dev/bus/usb
29588 device poll    	6  	0   /dev/bus/usb/004
29588 device poll    	7  	0   /dev/bus/usb/004/001
29588 device poll    	6  	0   /dev/bus/usb/003
^C
#
```

è¿™ä¸ªè¾“å‡ºçœ‹èµ·æ¥å’Œå‰é¢ä½¿ç”¨`bpftrace`çš„å•è¡Œè„šæœ¬è¾“å‡ºéå¸¸ç›¸ä¼¼â€”â€”è‡³å°‘åˆ—åæ˜¯ä¸€æ ·çš„ã€‚ä½†è¿™ä¸ª`opensnoop(8)`è¾“å‡ºç›¸æ¯”`bpftrace`çš„ç‰ˆæœ¬æœ‰ä¸€ä¸ªä¼˜åŠ¿ï¼šå®ƒæ”¯æŒå‘½ä»¤è¡Œå‚æ•°ã€‚

```bash
# opensnoop -h
usage: opensnoop [-h] [-T] [-x] [-p PID] [-t TID] [-d DURATION] [-n NAME]
                 [-e] [-f FLAG_FILTER]

Trace open() syscalls

å¯é€‰å‚æ•°:
  -h, --help                  æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯å¹¶é€€å‡º
  -T, --timestamp             è¾“å‡ºä¸­åŒ…å«æ—¶é—´æˆ³
  -x, --failed                åªæ˜¾ç¤ºå¤±è´¥çš„ open è°ƒç”¨
  -p PID, --pid PID           åªè¿½è¸ªæŒ‡å®šçš„è¿›ç¨‹ PID
  -t TID, --tid TID           åªè¿½è¸ªæŒ‡å®šçš„çº¿ç¨‹ TID
  -d DURATION, --duration     æŒ‡å®šè¿½è¸ªçš„æ€»æ—¶é•¿ï¼ˆç§’ï¼‰
  -n NAME, --name NAME        åªæ˜¾ç¤ºè¿›ç¨‹åä¸­åŒ…å«è¯¥å­—ç¬¦ä¸²çš„é¡¹
  -e, --extended_fields       æ˜¾ç¤ºæ‰©å±•å­—æ®µ
  -f FLAG_FILTER, --flag_filter FLAG_FILTER
                              æ ¹æ®open()çš„flagså‚æ•°è¿‡æ»¤ï¼ˆå¦‚O_WRONLYï¼‰

ç¤ºä¾‹ï¼š
./opensnoop               # è¿½è¸ªæ‰€æœ‰open()ç³»ç»Ÿè°ƒç”¨
./opensnoop -T            # è¾“å‡ºä¸­åŒ…å«æ—¶é—´æˆ³
./opensnoop -x            # åªæ˜¾ç¤ºå¤±è´¥çš„openè°ƒç”¨
./opensnoop -p 181        # åªè¿½è¸ªè¿›ç¨‹PIDä¸º181çš„è¿›ç¨‹
./opensnoop -t 123        # åªè¿½è¸ªçº¿ç¨‹TIDä¸º123çš„çº¿ç¨‹
./opensnoop -d 10         # åªè¿½è¸ª10ç§’
./opensnoop -n main       # åªæ˜¾ç¤ºè¿›ç¨‹ååŒ…å«"main"çš„æ¡ç›®
./opensnoop -e            # æ˜¾ç¤ºæ‰©å±•å­—æ®µ
./opensnoop -f O_WRONLY -f O_RDWR   # åªæ˜¾ç¤ºå…·æœ‰å†™æ“ä½œçš„è°ƒç”¨
```

`bpftrace`å·¥å…·é€šå¸¸è®¾è®¡å¾—ç®€å•åŒæ—¶ä¸“æ³¨äºå•ä¸€ç”¨é€”ï¼Œè€Œ`BCC`å·¥å…·é€šå¸¸æ›´å¤æ‚ï¼Œæ”¯æŒå¤šç§è¿è¡Œæ¨¡å¼ã€‚ä¾‹å¦‚ï¼Œä½ å¯ä»¥é€šè¿‡ä¿®æ”¹ `bpftrace`è„šæœ¬è®©å®ƒåªæ˜¾ç¤ºå¤±è´¥çš„`open`è°ƒç”¨ï¼Œä½†`BCC`ç‰ˆæœ¬å·²ç»å†…å»ºäº†è¿™ä¸ªé€‰é¡¹ï¼ˆ`-x`ï¼‰ï¼š

```bash
# opensnoop -x
PID    COMM              FD  ERR PATH
991    irqbalance        -1   2  /proc/irq/133/smp_affinity
991    irqbalance        -1   2  /proc/irq/141/smp_affinity
991    irqbalance        -1   2  /proc/irq/131/smp_affinity
991    irqbalance        -1   2  /proc/irq/138/smp_affinity
991    irqbalance        -1   2  /proc/irq/18/smp_affinity
20543  systemd-resolve   -1   2  /run/systemd/netif/links/5
20543  systemd-resolve   -1   2  /run/systemd/netif/links/5
20543  systemd-resolve   -1   2  /run/systemd/netif/links/5
[...]
```

è¿™ä¸ªè¾“å‡ºæ˜¾ç¤ºäº†å¤šä¸ªé‡å¤çš„å¤±è´¥è°ƒç”¨ã€‚è¿™ç§æ¨¡å¼å¯èƒ½è¡¨æ˜å­˜åœ¨æ•ˆç‡ä½ä¸‹æˆ–é…ç½®é”™è¯¯çš„é—®é¢˜ï¼Œéœ€è¦è¿›ä¸€æ­¥æ’æŸ¥ã€‚

`BCC`å·¥å…·é€šå¸¸æä¾›å¤šç§é€‰é¡¹æ¥è°ƒæ•´å…¶è¡Œä¸ºï¼Œè¿™è®©å®ƒä»¬æ¯”`bpftrace`å·¥å…·æ›´åŠ çµæ´»ã€‚å› æ­¤ï¼Œ`BCC`å·¥å…·æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„èµ·ç‚¹ï¼šå¦‚æœä½ èƒ½ç”¨ç°æˆçš„`BCC`å·¥å…·è§£å†³é—®é¢˜ï¼Œå°±æ— éœ€ç¼–å†™ä»»ä½•`BPF`ä»£ç ã€‚

ä¸è¿‡ï¼Œå¦‚æœå®ƒä»¬æ— æ³•æ»¡è¶³ä½ çš„å¯è§æ€§éœ€æ±‚ï¼Œä½ å¯ä»¥åˆ‡æ¢åˆ°`bpftrace`ï¼Œè‡ªè¡Œå¼€å‘å®šåˆ¶å·¥å…·â€”â€”å› ä¸º`bpftrace`è¯­è¨€æ›´ç®€å•ï¼Œå¼€å‘é—¨æ§›æ›´ä½ã€‚

å½“ç„¶ï¼Œ`bpftrace`å·¥å…·ä¹‹åä¹Ÿå¯ä»¥è¢«æ”¹å†™æˆæ”¯æŒä¸°å¯Œé€‰é¡¹çš„`BCC`å·¥å…·ï¼Œå°±åƒä¸Šé¢çš„`opensnoop(8)`ä¸€æ ·ã€‚æ­¤å¤–ï¼Œ`BCC`å·¥å…·è¿˜èƒ½æ ¹æ®å¯ç”¨æƒ…å†µé€‰æ‹©ä½¿ç”¨ä¸åŒçš„äº‹ä»¶æºï¼šå¦‚ä½¿ç”¨`tracepoints`ï¼ˆå¦‚æœå¯ç”¨ï¼‰ï¼Œå¦åˆ™ä½¿ç”¨`kprobes`ã€‚

ä½†è¦æ³¨æ„ï¼Œ`BCC`ç¼–ç¨‹æ›´å¤æ‚ï¼Œè¶…å‡ºäº†æœ¬ä¹¦çš„èŒƒå›´ï¼›æœ¬ä¹¦èšç„¦äº`bpftrace`çš„ä½¿ç”¨ã€‚

##### ğŸŒ² å°ç»“

`BPF`è¿½è¸ªå·¥å…·å¹¿æ³›ç”¨äºæ€§èƒ½åˆ†æå’Œæ•…éšœæ’æŸ¥ï¼Œç›®å‰æœ‰ä¸¤ä¸ªä¸»è¦é¡¹ç›®æä¾›è¿™äº›å·¥å…·ï¼š`BCC`å’Œ`bpftrace`ã€‚æœ¬ç« ä»‹ç»äº†æ‰©å±•`BPF`ï¼ˆ`eBPF`ï¼‰ã€`BCC`ã€`bpftrace`ï¼Œä»¥åŠå®ƒä»¬ä½¿ç”¨çš„åŠ¨æ€ä¸é™æ€æ’æ¡©æŠ€æœ¯ã€‚