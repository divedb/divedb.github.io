---
date: 2025-07-28
layout: post
title: Etcdå­˜å‚¨çš„å®ç°
categories: äº‘åŸç”Ÿ
tags: [äº‘åŸç”Ÿ, etcd] 
---

è½¬è½½ï¼š[Etcdå­˜å‚¨çš„å®ç°](https://www.codedump.info/post/20181125-etcd-server/)

åœ¨å‰é¢å·²ç»åˆ†æäº†`Raft`ç®—æ³•åŸç†ã€`etcd raft`åº“çš„å®ç°ï¼Œæ¥ç€å°±å¯ä»¥çœ‹`etcd`å¦‚ä½•ä½¿ç”¨`raft`å®ç°å­˜å‚¨æœåŠ¡çš„äº†ã€‚

ä»¥ä¸‹çš„åˆ†æä¸»è¦é’ˆå¯¹`etcd V3`ç‰ˆæœ¬çš„å®ç°ã€‚

ä¸‹å›¾ä¸­å±•ç¤ºäº†`etcd`å¦‚ä½•å¤„ç†ä¸€ä¸ªå®¢æˆ·ç«¯è¯·æ±‚çš„æ¶‰åŠåˆ°çš„æ¨¡å—å’Œæµç¨‹ã€‚å›¾ä¸­æ·¡ç´«è‰²çš„çŸ©å½¢è¡¨ç¤º`etcd`ï¼Œå®ƒåŒ…æ‹¬å¦‚ä¸‹å‡ ä¸ªæ¨¡å—ï¼š

-   `etcd server`ï¼šå¯¹å¤–æ¥æ”¶å®¢æˆ·ç«¯çš„è¯·æ±‚ï¼Œå¯¹åº”`etcd`ä»£ç ä¸­çš„`etcdserver`ç›®å½•ï¼Œå…¶ä¸­è¿˜æœ‰ä¸€ä¸ª`raft.go`çš„æ¨¡å—ä¸`etcd-raft`åº“è¿›è¡Œé€šä¿¡ã€‚`etcdserver`ä¸­ä¸å­˜å‚¨ç›¸å…³çš„æ¨¡å—æ˜¯`applierV3`ï¼Œè¿™é‡Œå°è£…äº†`V3`ç‰ˆæœ¬çš„æ•°æ®å­˜å‚¨ï¼Œ`WAL`ï¼ˆ`write ahead log`ï¼‰ï¼Œç”¨äºå†™æ•°æ®æ—¥å¿—ï¼Œ`etcd`å¯åŠ¨æ—¶ä¼šæ ¹æ®è¿™éƒ¨åˆ†å†…å®¹è¿›è¡Œæ¢å¤ã€‚
-   `etcd raft`ï¼š`etcd`çš„`raft`åº“ï¼Œå‰é¢çš„æ–‡ç« å·²ç»å…·ä½“åˆ†æè¿‡è¿™éƒ¨åˆ†ä»£ç ã€‚é™¤äº†ä¸æœ¬èŠ‚ç‚¹çš„`etcd server`é€šä¿¡ä¹‹å¤–ï¼Œè¿˜ä¸é›†ç¾¤ä¸­çš„å…¶ä»–`etcd server`è¿›è¡Œäº¤äº’åšä¸€è‡´æ€§æ•°æ®åŒæ­¥çš„å·¥ä½œï¼ˆåœ¨å›¾ä¸­é›†ç¾¤ä¸­å…¶ä»–`etcd`æœåŠ¡ç”¨æ©™è‰²çš„æ¤­åœ†è¡¨ç¤ºï¼‰ã€‚



![etcd server](https://www.codedump.info/media/imgs/20181125-etcd-server/etcd-server.png)

åœ¨ä¸Šå›¾ä¸­ï¼Œä¸€ä¸ªè¯·æ±‚ä¸ä¸€ä¸ªetcdé›†ç¾¤äº¤äº’çš„ä¸»è¦æµç¨‹åˆ†ä¸ºä¸¤å¤§éƒ¨åˆ†ï¼š

1.  å†™æ•°æ®åˆ°æŸä¸ªetcd serverä¸­ã€‚
2.  è¯¥etcd serverä¸é›†ç¾¤ä¸­çš„å…¶ä»–etcdèŠ‚ç‚¹è¿›è¡Œäº¤äº’ï¼Œå½“ç¡®ä¿æ•°æ®å·²ç»è¢«å­˜å‚¨ä¹‹ååº”ç­”å®¢æˆ·ç«¯ã€‚

è¯·æ±‚æµç¨‹åˆ’åˆ†ä¸ºäº†ä»¥ä¸‹çš„å­æ­¥éª¤ï¼š

-   1.1ï¼šetcd serveræ”¶åˆ°å®¢æˆ·ç«¯è¯·æ±‚ã€‚
-   1.2ï¼šetcd serverå°†è¯·æ±‚å‘é€ç»™æœ¬æ¨¡å—ä¸­çš„raft.goï¼Œè¿™é‡Œè´Ÿè´£ä¸etcd raftæ¨¡å—è¿›è¡Œé€šä¿¡ã€‚
-   1.3ï¼šraft.goå°†æ•°æ®å°è£…æˆraftæ—¥å¿—çš„å½¢å¼æäº¤ç»™raftæ¨¡å—ã€‚
-   1.4ï¼šraftæ¨¡å—ä¼šé¦–å…ˆä¿å­˜åˆ°raftLogçš„unstableå­˜å‚¨éƒ¨åˆ†ã€‚
-   1.5ï¼šraftæ¨¡å—é€šè¿‡raftåè®®ä¸é›†ç¾¤ä¸­å…¶ä»–etcdèŠ‚ç‚¹è¿›è¡Œäº¤äº’ã€‚

æ³¨æ„åœ¨ä»¥ä¸Šæµç¨‹ä¸­ï¼Œå‡è®¾è¿™é‡Œå†™å…¥æ•°æ®çš„etcdæ˜¯leaderèŠ‚ç‚¹ï¼Œå› ä¸ºåœ¨raftåè®®ä¸­ï¼Œå¦‚æœæäº¤æ•°æ®åˆ°éleaderèŠ‚ç‚¹çš„è¯éœ€è¦è·¯ç”±åˆ°etcd leaderèŠ‚ç‚¹å»ã€‚

è€Œåº”ç­”æ­¥éª¤å¦‚ä¸‹ï¼š

-   2.1ï¼šé›†ç¾¤ä¸­å…¶ä»–èŠ‚ç‚¹å‘leaderèŠ‚ç‚¹åº”ç­”æ¥æ”¶è¿™æ¡æ—¥å¿—æ•°æ®ã€‚
-   2.2ï¼šå½“è¶…è¿‡é›†ç¾¤åŠæ•°ä»¥ä¸ŠèŠ‚ç‚¹åº”ç­”æ¥æ”¶è¿™æ¡æ—¥å¿—æ•°æ®æ—¶ï¼Œetcd rafté€šè¿‡Readyç»“æ„ä½“é€šçŸ¥etcd serverä¸­çš„raftè¯¥æ—¥å¿—æ•°æ®å·²ç»commitã€‚
-   2.3ï¼šraft.goæ”¶åˆ°Readyæ•°æ®å°†é¦–å…ˆå°†è¿™æ¡æ—¥å¿—å†™å…¥åˆ°WALæ¨¡å—ä¸­ã€‚
-   2.4ï¼šé€šçŸ¥æœ€ä¸Šå±‚çš„etcd serverè¯¥æ—¥å¿—å·²ç»commitã€‚
-   2.5ï¼šetcd serverè°ƒç”¨applierV3æ¨¡å—å°†æ—¥å¿—å†™å…¥æŒä¹…åŒ–å­˜å‚¨ä¸­ã€‚
-   2.6ï¼šetcd serveråº”ç­”å®¢æˆ·ç«¯è¯¥æ•°æ®å†™å…¥æˆåŠŸã€‚
-   2.7ï¼šæœ€åetcd serverè°ƒç”¨etcd raftï¼Œä¿®æ”¹å…¶raftLogæ¨¡å—çš„æ•°æ®ï¼Œå°†è¿™æ¡æ—¥å¿—å†™å…¥åˆ°raftLogçš„storageä¸­ã€‚

ä»ä¸Šé¢çš„æµç¨‹å¯ä»¥çœ‹åˆ°

-   etcd raftæ¨¡å—åœ¨åº”ç­”æŸæ¡æ—¥å¿—æ•°æ®å·²ç»commitä¹‹åï¼Œæ˜¯é¦–å…ˆå†™å…¥åˆ°WALæ¨¡å—ä¸­çš„ï¼Œå› ä¸ºè¿™ä¸ªæ¨¡å—åªæ˜¯æ·»åŠ ä¸€æ¡æ—¥å¿—ï¼Œæ‰€ä»¥é€Ÿåº¦ä¼šå¾ˆå¿«ï¼Œå³ä½¿åœ¨åé¢applierV3å†™å…¥å¤±è´¥ï¼Œé‡å¯çš„æ—¶å€™ä¹Ÿå¯ä»¥æ ¹æ®WALæ¨¡å—ä¸­çš„æ—¥å¿—æ•°æ®è¿›è¡Œæ¢å¤ã€‚
-   etcd raftä¸­çš„raftLogï¼ŒæŒ‰ç…§å‰é¢æ–‡ç« çš„åˆ†æï¼Œå…¶ä¸­çš„æ•°æ®æ˜¯ä¿å­˜åˆ°å†…å­˜ä¸­çš„ï¼Œé‡å¯å³å¤±æ•ˆï¼Œä¸Šå±‚åº”ç”¨çœŸå®çš„æ•°æ®æ˜¯æŒä¹…åŒ–ä¿å­˜åˆ°WALå’ŒapplierV3ä¸­çš„ã€‚

ä»¥ä¸‹å°±æ¥åˆ†æetcd serverä¸è¿™éƒ¨åˆ†ç›¸å…³çš„å‡ ä¸ªæ¨¡å—ã€‚

# etcd serverä¸raftçš„äº¤äº’ 

EtcdServerç»“æ„ä½“ï¼Œè´Ÿè´£å¯¹å¤–ä¸å®¢æˆ·ç«¯è¿›è¡Œé€šä¿¡ã€‚å†…éƒ¨æœ‰ä¸€ä¸ªraftNodeç»“æ„çš„æˆå‘˜ï¼Œè´Ÿè´£ä¸etcdçš„raftåº“è¿›è¡Œäº¤äº’ã€‚

etcd V3ç‰ˆæœ¬çš„APIï¼Œé€šè¿‡GRPCåè®®ä¸å®¢æˆ·ç«¯è¿›è¡Œäº¤äº’ï¼Œå…¶ç›¸å…³ä»£ç åœ¨etcdserver/v3_server.goä¸­ã€‚ä»¥ä¸€æ¬¡Putè¯·æ±‚ä¸ºä¾‹ï¼Œæœ€åå°†ä¼šè°ƒç”¨çš„ä»£ç åœ¨å‡½æ•°EtcdServer::processInternalRaftRequestOnceä¸­ï¼Œä»£ç çš„ä¸»è¦æµç¨‹åˆ†æå¦‚ä¸‹ã€‚



![etcd flowchart](https://www.codedump.info/media/imgs/20181125-etcd-server/etcd-flowchart.png)

etcd flowchart



1.  æ‹¿åˆ°å½“å‰raftä¸­çš„applyå’Œcommitç´¢å¼•ï¼Œå¦‚æœcommitç´¢å¼•æ¯”applyç´¢å¼•è¶…å‡ºå¤ªå¤šï¼Œè¯´æ˜å½“å‰æœ‰å¾ˆå¤šæ•°æ®éƒ½æ²¡æœ‰applyï¼Œè¿”å›ErrTooManyRequestsé”™è¯¯ã€‚
2.  è°ƒç”¨s.reqIDGen.Next()å‡½æ•°ç”Ÿæˆä¸€ä¸ªé’ˆå¯¹å½“å‰è¯·æ±‚çš„IDï¼Œæ³¨æ„è¿™ä¸ªIDå¹¶ä¸æ˜¯ä¸€ä¸ªéšæœºæ•°è€Œæ˜¯ä¸€ä¸ªä¸¥æ ¼é€’å¢çš„æ•´æ•°ã€‚åŒæ—¶å°†è¯·æ±‚åºåˆ—åŒ–ä¸ºbyteæ•°æ®ï¼Œè¿™ä¼šåšä¸ºraftçš„æ•°æ®è¿›è¡Œå­˜å‚¨ã€‚
3.  æ ¹æ®ç¬¬2æ­¥ä¸­çš„IDï¼Œè°ƒç”¨Wait.Registerå‡½æ•°è¿›è¡Œæ³¨å†Œï¼Œè¿™ä¼šè¿”å›ä¸€ä¸ªç”¨äºé€šçŸ¥ç»“æœçš„channelï¼Œåç»­å°±é€šè¿‡ç›‘å¬è¯¥channelæ¥ç¡®å®šæ˜¯å¦æˆåŠŸå‚¨å­˜äº†æäº¤çš„å€¼ã€‚
4.  è°ƒç”¨Raft.Processå‡½æ•°æäº¤æ•°æ®ï¼Œè¿™é‡Œä¼ å…¥çš„å‚æ•°é™¤äº†å‰é¢åºåˆ—åŒ–çš„æ•°æ®ä¹‹å¤–ï¼Œè¿˜æœ‰ä½¿ç”¨è¶…æ—¶æ—¶é—´åˆ›å»ºçš„Contextã€‚
5.  ç›‘å¬å‰é¢çš„Channelä»¥åŠContextå¯¹è±¡ï¼š a. å¦‚æœcontext.Doneè¿”å›ï¼Œè¯´æ˜æ•°æ®æäº¤è¶…æ—¶ï¼Œä½¿ç”¨s.parseProposeCtxErrå‡½æ•°è¿”å›å…·ä½“çš„é”™è¯¯ã€‚ b. å¦‚æœchannelè¿”å›ï¼Œè¯´æ˜å·²ç»æäº¤æˆåŠŸã€‚

ä»ä»¥ä¸Šçš„æµç¨‹å¯ä»¥çœ‹å‡ºï¼Œåœ¨è°ƒç”¨Raft.Processå‡½æ•°å‘Raftåº“æäº¤æ•°æ®ä¹‹åï¼Œç­‰å¾…è¢«å”¤é†’çš„Channelæ‰æ˜¯æ­£å¸¸æäº¤æ•°æ®æˆåŠŸçš„è·¯å¾„ã€‚

åœ¨EtcdServer.runå‡½æ•°ä¸­ï¼Œæœ€ç»ˆä¼šè¿›å…¥ä¸€ä¸ªæ­»å¾ªç¯ä¸­ï¼Œç­‰å¾…raftNode.applyè¿”å›çš„channelè¢«å”¤é†’ï¼Œè€ŒraftNodeç»§æ‰¿äº†raft.Nodeçš„å®ç°ï¼Œä»å‰é¢åˆ†æetcd raftçš„æµç¨‹ä¸­å¯ä»¥æ˜ç™½ï¼ŒEtcdServerå°±æ˜¯åœ¨å‘raftåº“æäº¤äº†æ•°æ®ä¹‹åï¼Œåšä¸ºå…¶ä¸Šå±‚æ¶ˆè´¹Readyæ•°æ®çš„åº”ç”¨å±‚ã€‚

è‡ªæ­¤ï¼Œæ•´ä½“çš„æµç¨‹å¤§ä½“å·²ç»æ¸…æ™°ï¼š

1.  EtcdServerå¯¹å¤–é€šè¿‡GRPCåè®®æ¥æ”¶å®¢æˆ·ç«¯è¯·æ±‚ï¼Œå¯¹å†…æœ‰ä¸€ä¸ªraftNodeç±»å‹çš„æˆå‘˜ï¼Œè¯¥ç±»å‹ç»§æ‰¿äº†raft.Nodeçš„å®ç°ã€‚
2.  å®¢æˆ·ç«¯é€šè¿‡EtcdServeræäº¤çš„æ•°æ®ä¿®æ”¹éƒ½ä¼šé€šè¿‡raftNodeæ¥æäº¤ï¼Œè€ŒEtcdServeræœ¬èº«é€šè¿‡ç›‘å¬channelä¸raftåº“è¿›è¡Œé€šä¿¡ï¼Œç”±Readyç»“æ„ä½“æ¥é€šè¿‡EtcdServerå“ªäº›æ•°æ®å·²ç»æäº¤æˆåŠŸã€‚
3.  ç”±äºæ¯ä¸ªè¯·æ±‚éƒ½ä¼šä¸€ä¸ªå¯¹åº”çš„IDï¼ŒIDç»‘å®šäº†Channelï¼Œæ‰€ä»¥æäº¤æˆåŠŸçš„è¯·æ±‚é€šè¿‡IDæ‰¾åˆ°å¯¹åº”çš„Channelæ¥å”¤é†’æäº¤æµç¨‹ï¼Œæœ€åé€šçŸ¥å®¢æˆ·ç«¯æäº¤æ•°æ®æˆåŠŸã€‚

##### ğŸŒ² `WAL` 

ä»¥ä¸Šä»‹ç»äº†`EtcdServer`çš„å¤§ä½“æµç¨‹ï¼Œæ¥ä¸‹æ¥çœ‹`WAL`çš„å®ç°ã€‚

å‰é¢å·²ç»åˆ†æè¿‡äº†ï¼Œ`etcd raft`æäº¤æ•°æ®æˆåŠŸä¹‹åï¼Œå°†é€šçŸ¥ä¸Šé¢çš„åº”ç”¨å±‚ï¼ˆåœ¨è¿™é‡Œå°±æ˜¯`EtcdServer`ï¼‰ï¼Œç„¶åå†è¿›è¡ŒæŒä¹…åŒ–æ•°æ®å­˜å‚¨ã€‚è€Œæ•°æ®çš„æŒä¹…åŒ–å¯èƒ½ä¼šèŠ±è´¹ä¸€äº›æ—¶é—´ï¼Œå› æ­¤åœ¨åº”ç­”åº”ç”¨å±‚ä¹‹å‰ï¼Œ`EtcdServer`ä¸­çš„`raftNode`ä¼šé¦–å…ˆå°†è¿™äº›æ•°æ®å†™å…¥`WAL`æ—¥å¿—ä¸­ã€‚è¿™æ ·å³ä½¿åœ¨åšæŒä¹…åŒ–çš„æ—¶å€™æ•°æ®ä¸¢å¤±äº†ï¼Œå¯åŠ¨æ¢å¤çš„æ—¶å€™ä¹Ÿå¯ä»¥æ ¹æ®`WAL`çš„æ—¥å¿—è¿›è¡Œæ•°æ®æ¢å¤ã€‚

`EtcdServer`æ¨¡å—ä¸­ï¼Œç»™`raftNode`ç”¨äºå†™`WAL`æ—¥å¿—çš„å·¥ä½œï¼Œäº¤ç»™äº†æ¥å£`Storage`æ¥å®Œæˆï¼Œ`storage`å®ç°äº†è¿™ä¸ªæ¥å£ï¼š

```Go
type storage struct {
	*wal.WAL
	*snap.Snapshotter
}
```

å¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ªç»“æ„ä½“ç»„åˆäº†`WAL`å’Œ`snap.Snapshotter`ç»“æ„ï¼Œ`Snapshotter`è´Ÿè´£çš„æ˜¯å­˜å‚¨å¿«ç…§æ•°æ®ã€‚

`WAL`æ—¥å¿—æ–‡ä»¶ä¸­ï¼Œæ¯æ¡æ—¥å¿—è®°å½•åŒ…å«ä»¥ä¸‹å†…å®¹ï¼š

-   `Type`ï¼šæ—¥å¿—è®°å½•ç±»å‹ï¼›

-   `Crc`ï¼šæ—¥å¿—è®°å½•çš„æ ¡éªŒå’Œï¼›
-   `Data`ï¼šçœŸæ­£çš„æ•°æ®ï¼Œæ ¹æ®ç±»å‹ä¸åŒå­˜å‚¨çš„æ•°æ®ä¹Ÿä¸åŒã€‚

æ—¥å¿—è®°å½•æœ‰å¦‚ä¸‹çš„ç±»å‹ï¼š

-   `metadataType`ï¼šå­˜å‚¨çš„æ˜¯å…ƒæ•°æ®ï¼Œæ¯ä¸ª`WAL`æ–‡ä»¶å¼€å¤´éƒ½æœ‰è¿™ç±»å‹çš„ä¸€æ¡è®°å½•æ•°æ®ï¼›

-   `entryType`ï¼šä¿å­˜çš„æ˜¯`raft`çš„æ•°æ®ï¼Œä¹Ÿå°±æ˜¯å®¢æˆ·ç«¯æäº¤ä¸Šæ¥å¹¶ä¸”å·²ç»`commit`çš„æ•°æ®ï¼›
-   `stateType`ï¼šä¿å­˜çš„æ˜¯å½“å‰é›†ç¾¤çš„çŠ¶æ€ä¿¡æ¯ï¼Œå³å‰é¢æåˆ°çš„`HardState`ï¼›

-   `crcType`ï¼šæ ¡éªŒæ•°æ®ï¼›

-   `snapshotType`ï¼šå¿«ç…§æ•°æ®ã€‚

`Etcd`ä½¿ç”¨ä¸¤ä¸ªç›®å½•åˆ†åˆ«å­˜æ”¾`WAL`æ–‡ä»¶ä»¥åŠå¿«ç…§æ–‡ä»¶ã€‚å…¶ä¸­ï¼Œ`WAL`æ–‡ä»¶çš„æ–‡ä»¶åæ ¼å¼æ˜¯â€œ16ä½çš„WALæ–‡ä»¶ç¼–å·-è¯¥WALç¬¬ä¸€æ¡entryæ•°æ®çš„indexå·.walâ€ï¼Œè¿™æ ·å°±èƒ½ä»`WAL`æ–‡ä»¶åçŸ¥é“è¯¥`WAL`æ–‡ä»¶ä¸­ä¿å­˜çš„`entry`æ•°æ®è‡³å°‘å¤§äºä»€ä¹ˆç´¢å¼•å·ã€‚è€Œå¿«ç…§æ–‡ä»¶åçš„æ ¼å¼åˆ™æ˜¯â€œ16ä½çš„å¿«ç…§æ•°æ®æœ€åä¸€æ¡æ—¥å¿—è®°å½•ä»»æœŸå·-16ä½çš„å¿«ç…§æ•°æ®æœ€åä¸€æ¡è®°å½•çš„ç´¢å¼•å·.snapâ€ã€‚

`Etcd`ä¼šç®¡ç†`WAL`ç›®å½•ä¸­çš„æ‰€æœ‰`WAL`æ–‡ä»¶ï¼Œä½†æ˜¯åœ¨ç”Ÿæˆå¿«ç…§æ–‡ä»¶ä¹‹åï¼Œåœ¨å¿«ç…§æ•°æ®ä¹‹å‰çš„`WAL`æ–‡ä»¶å°†è¢«æ¸…é™¤æ‰ï¼Œä¿è¯ç£ç›˜ä¸ä¼šä¸€ç›´å¢é•¿ã€‚

å‡è®¾å½“å‰`Etcd`ä¸­æœ‰ä¸‰ä¸ª`WAL`æ–‡ä»¶ï¼Œå¯ä»¥ä»è¿™äº›æ–‡ä»¶çš„æ–‡ä»¶åçŸ¥é“å…¶ä¸­å­˜æ”¾æ•°æ®çš„ç´¢å¼•èŒƒå›´ã€‚



![etcd wal1](https://www.codedump.info/media/imgs/20181125-etcd-server/etcd-wal1.png)

åœ¨ç”Ÿæˆå¿«ç…§æ–‡ä»¶ä¹‹åï¼Œæ­¤æ—¶å°±åªå‰©ä¸€ä¸ª`WAL`æ–‡ä»¶å’Œä¸€ä¸ªå¿«ç…§æ–‡ä»¶äº†ï¼š



![etcd wal2](https://www.codedump.info/media/imgs/20181125-etcd-server/etcd-wal2.png)

é‚£ä¹ˆï¼Œåˆæ˜¯åœ¨ä»€ä¹ˆæƒ…å†µä¸‹ç”Ÿæˆå¿«ç…§æ–‡ä»¶å‘¢ï¼Ÿ`EtcdServer`åœ¨ä¸»å¾ªç¯ä¸­é€šè¿‡ç›‘å¬`channel`è·çŸ¥å½“å‰`raft`åè®®è¿”å›çš„`Ready`æ•°æ®ï¼Œå¦‚æœå½“å‰ä¿å­˜çš„å¿«ç…§æ•°æ®ç´¢å¼•è·ç¦»ä¸Šä¸€æ¬¡å·²ç»è¶…è¿‡ä¸€ä¸ªé˜ˆå€¼ï¼ˆ`EtcdServer.snapCount`ï¼‰ï¼Œæ­¤æ—¶å°±ä»`raft`çš„å­˜å‚¨ä¸­ç”Ÿæˆä¸€ä»½å½“å‰çš„å¿«ç…§æ•°æ®ï¼Œå†™å…¥å¿«ç…§æ–‡ä»¶æˆåŠŸä¹‹åï¼Œå°±å¯ä»¥å°†è¿™ä¹‹å‰çš„`WAL`æ–‡ä»¶é‡Šæ”¾äº†ã€‚

ä»¥ä¸Šæµç¨‹å’Œå¯¹åº”çš„å…·ä½“å‡½æ•°è§ä¸‹é¢çš„æµç¨‹å›¾ã€‚



![etcd snapshot](https://www.codedump.info/media/imgs/20181125-etcd-server/etcd-snapshot.png)

##### ğŸŒ² `backend store`çš„å®ç° 

###### ğŸƒ `revision`æ¦‚å¿µ 

`Etcd`å­˜å‚¨æ•°æ®æ—¶ï¼Œå¹¶ä¸æ˜¯åƒå…¶ä»–çš„`KV`å­˜å‚¨é‚£æ ·ï¼Œå­˜æ”¾æ•°æ®çš„é”®åšä¸º`key`ï¼Œè€Œæ˜¯ä»¥æ•°æ®çš„`revision`åšä¸º`key`ï¼Œé”®å€¼åšä¸ºæ•°æ®æ¥å­˜æ”¾ã€‚å¦‚ä½•ç†è§£`revision`è¿™ä¸ªæ¦‚å¿µï¼Œä»¥ä¸‹é¢çš„ä¾‹å­æ¥è¯´æ˜ã€‚

æ¯”å¦‚é€šè¿‡æ‰¹é‡æ¥å£ä¸¤æ¬¡æ›´æ–°ä¸¤å¯¹é”®å€¼ï¼Œç¬¬ä¸€æ¬¡å†™å…¥æ•°æ®æ—¶ï¼Œå†™å…¥`<key1,value1>`å’Œ`<key2,value2>`ï¼Œåœ¨`Etcd`è¿™è¾¹çš„å­˜å‚¨çœ‹æ¥ï¼Œå­˜æ”¾çš„æ•°æ®å°±æ˜¯è¿™æ ·çš„ï¼š

```bash
revision={1,0}, key=key1, value=value1
revision={1,1}, key=key2, value=value2
```

è€Œåœ¨ç¬¬äºŒæ¬¡æ›´æ–°å†™å…¥æ•°æ®`<key1,update1>`å’Œ`<key2,update2>`åï¼Œå­˜å‚¨ä¸­åˆè®°å½•ï¼ˆæ³¨æ„ä¸æ˜¯è¦†ç›–å‰é¢çš„æ•°æ®ï¼‰äº†ä»¥ä¸‹æ•°æ®ï¼š

```bash
revision={2,0}, key=key1, value=update1
revision={2,1}, key=key2, value=update2
```

å…¶ä¸­`revision`æœ‰ä¸¤éƒ¨åˆ†ç»„æˆï¼Œç¬¬ä¸€éƒ¨åˆ†æˆä¸º`main revision`ï¼Œæ¯æ¬¡äº‹åŠ¡é€’å¢1ï¼›ç¬¬äºŒéƒ¨åˆ†ç§°ä¸º`sub revision`ï¼Œä¸€ä¸ªäº‹åŠ¡å†…çš„ä¸€æ¬¡æ“ä½œé€’å¢1ã€‚ ä¸¤è€…ç»“åˆï¼Œå°±èƒ½ä¿è¯æ¯æ¬¡`key`å”¯ä¸€è€Œä¸”æ˜¯é€’å¢çš„ã€‚

![etcd revision](https://www.codedump.info/media/imgs/20181125-etcd-server/etcd-revision.png)

ä½†æ˜¯ï¼Œå°±å®¢æˆ·ç«¯çœ‹æ¥ï¼Œæ¯æ¬¡æ“ä½œçš„æ—¶å€™æ˜¯æ ¹æ®`key`æ¥è¿›è¡Œæ“ä½œçš„ï¼Œæ‰€ä»¥è¿™é‡Œå°±éœ€è¦ä¸€ä¸ª`key`æ˜ å°„åˆ°å½“å‰`revision`çš„æ“ä½œäº†ï¼Œä¸ºäº†åšåˆ°è¿™ä¸ªæ˜ å°„å…³ç³»ï¼Œ`Etcd`å¼•å…¥äº†ä¸€ä¸ªå†…å­˜ä¸­çš„`Btree`ç´¢å¼•ï¼Œæ•´ä¸ªæ“ä½œè¿‡ç¨‹å¦‚ä¸‹é¢çš„æµç¨‹æ‰€ç¤ºã€‚



![etcd keyindex](https://www.codedump.info/media/imgs/20181125-etcd-server/etcd-keyindex.png)

æŸ¥è¯¢æ—¶ï¼Œå…ˆé€šè¿‡å†…å­˜ä¸­çš„`Btree`ç´¢å¼•æ¥æŸ¥è¯¢è¯¥`key`å¯¹åº”çš„`keyIndex`ç»“æ„ä½“ï¼Œç„¶åå†æ ¹æ®è¿™ä¸ªç»“æ„ä½“æ‰èƒ½å»`boltdb`ä¸­æŸ¥è¯¢çœŸå®çš„æ•°æ®è¿”å›ã€‚

æ‰€ä»¥ï¼Œä¸‹é¢å…ˆå±•å¼€è®¨è®ºè¿™ä¸ª`keyIndex`ç»“æ„ä½“å’Œ`Btree`ç´¢å¼•ã€‚

###### ğŸƒ `keyIndex`ç»“æ„ 

keyIndexç»“æ„ä½“æœ‰ä»¥ä¸‹æˆå‘˜ï¼š

-   keyï¼šå­˜å‚¨æ•°æ®çœŸå®çš„é”®ã€‚
-   modifiedï¼šæœ€åä¸€æ¬¡ä¿®æ”¹è¯¥é”®å¯¹åº”çš„revisionã€‚
-   generationsï¼šgenerationæ•°ç»„ã€‚

å¦‚ä½•ç†è§£generationç»“æ„å‘¢ï¼Œå¯ä»¥è®¤ä¸ºæ¯ä¸ªgenerationå¯¹åº”ä¸€ä¸ªæ•°æ®ä»åˆ›å»ºåˆ°åˆ é™¤çš„è¿‡ç¨‹ã€‚æ¯æ¬¡åˆ é™¤keyçš„æ“ä½œï¼Œéƒ½ä¼šå¯¼è‡´ä¸€ä¸ªgenerationæœ€åæ·»åŠ ä¸€ä¸ªtombstoneè®°å½•ï¼Œç„¶ååˆ›å»ºä¸€ä¸ªæ–°çš„ç©ºgenerationè®°å½•æ·»åŠ åˆ°generationsæ•°ç»„ä¸­ã€‚

generationç»“æ„ä½“å­˜æ”¾ä»¥ä¸‹æ•°æ®ï¼š

-   verï¼šå½“å‰generationä¸­å­˜æ”¾äº†å¤šå°‘æ¬¡ä¿®æ”¹ï¼Œå…¶å®å°±æ˜¯revsæ•°ç»„çš„å¤§å°-1ï¼ˆå› ä¸ºéœ€è¦å»æ‰tombstoneï¼‰ã€‚
-   createdï¼šåˆ›å»ºè¯¥generationæ—¶çš„revisionã€‚
-   revsï¼šå­˜æ”¾è¯¥generationä¸­å­˜æ”¾çš„revisionæ•°ç»„ã€‚

ä»¥ä¸‹å›¾æ¥è¯´æ˜keyIndexç»“æ„ä½“ï¼š



![etcd keyindex struct](https://www.codedump.info/media/imgs/20181125-etcd-server/etcd-keyindex-struct.png)

etcd keyindex struct



å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œå­˜æ”¾çš„é”®ä¸ºtestçš„keyIndexç»“æ„ã€‚

å®ƒçš„generationsæ•°ç»„æœ‰ä¸¤æ¡è®°å½•ï¼Œå…¶ä¸­generations[0]åœ¨revision 1.0æ—¶åˆ›å»ºï¼Œå½“revision2.1çš„æ—¶å€™è¿›è¡Œtombstoneæ“ä½œï¼Œå› æ­¤è¯¥generationçš„createdæ˜¯1.0ï¼›å¯¹åº”çš„generations[1]åœ¨revision3.3æ—¶åˆ›å»ºï¼Œç´§è·Ÿç€å°±åšäº†tombstoneæ“ä½œã€‚

æ‰€ä»¥è¯¥keyIndex.modifiledæˆå‘˜å­˜æ”¾çš„æ˜¯3.3ï¼Œå› ä¸ºè¿™æ˜¯è¿™æ¡æ•°æ®æœ€åä¸€æ¬¡è¢«ä¿®æ”¹çš„revisionã€‚

ä¸€ä¸ªå·²ç»è¢«tombstoneçš„generationæ˜¯å¯ä»¥è¢«åˆ é™¤çš„ï¼Œå¦‚æœæ•´ä¸ªgenerationsæ•°ç»„éƒ½å·²ç»è¢«åˆ é™¤ç©ºäº†ï¼Œé‚£ä¹ˆæ•´ä¸ªkeyIndexè®°å½•ä¹Ÿå¯ä»¥è¢«åˆ é™¤äº†ã€‚



![etcd generation_compact](https://www.codedump.info/media/imgs/20181125-etcd-server/etcd-generation-compact.png)

etcd generation compact



å¦‚ä¸Šå›¾æ‰€ç¤ºï¼ŒkeyIndex.compact(n)å‡½æ•°å¯ä»¥å¯¹keyIndexæ•°æ®è¿›è¡Œå‹ç¼©æ“ä½œï¼Œå°†åˆ é™¤æ»¡è¶³main revision < nçš„æ•°æ®ã€‚

-   compact(2)ï¼šæ‰¾åˆ°äº†generations[0]çš„1.0 revisionçš„æ•°æ®è¿›è¡Œäº†åˆ é™¤ã€‚
-   compact(3)ï¼šæ‰¾åˆ°äº†generations[0]çš„2.1 revisionçš„æ•°æ®è¿›è¡Œäº†åˆ é™¤ï¼Œæ­¤æ—¶ç”±äºgenerations[0]å·²ç»æ²¡æœ‰æ•°æ®äº†ï¼Œæ‰€ä»¥è¿™ä¸€æ•´ä¸ªgenerationè¢«åˆ é™¤ï¼ŒåŸå…ˆçš„generations[1]å˜æˆäº†generations[0]ã€‚
-   compact(4)ï¼šæ‰¾åˆ°äº†generations[0]çš„3.3 revisionçš„æ•°æ®è¿›è¡Œäº†åˆ é™¤ã€‚ç”±äºæ‰€æœ‰çš„generationæ•°æ®éƒ½è¢«åˆ é™¤äº†ï¼Œæ­¤æ—¶è¿™ä¸ªkeyIndexæ•°æ®å¯ä»¥åˆ é™¤äº†ã€‚

## treeIndexç»“æ„ 

Etcdä¸­ä½¿ç”¨treeIndexæ¥åœ¨å†…å­˜ä¸­å­˜æ”¾keyIndexæ•°æ®ä¿¡æ¯ï¼Œè¿™æ ·å°±å¯ä»¥å¿«é€Ÿçš„æ ¹æ®è¾“å…¥çš„keyå®šä½åˆ°å¯¹åº”çš„keyIndexã€‚

treeIndexä½¿ç”¨å¼€æºçš„github.com/google/btreeæ¥åœ¨å†…å­˜ä¸­å­˜å‚¨btreeç´¢å¼•ä¿¡æ¯ï¼Œå› ä¸ºç”¨çš„æ˜¯å¤–éƒ¨åº“ï¼Œæ‰€ä»¥ä¸æ‰“ç®—å°±è¿™éƒ¨åˆ†åšè§£é‡Šã€‚è€Œå¦‚æœå¾ˆæ¸…æ¥šäº†å‰é¢keyIndexç»“æ„ï¼Œå…¶å®è¿™éƒ¨åˆ†å¾ˆå¥½ç†è§£ã€‚

æ‰€æœ‰çš„æ“ä½œéƒ½ä»¥keyåšä¸ºå‚æ•°è¿›è¡Œæ“ä½œï¼ŒtreeIndexä½¿ç”¨btreeæ ¹æ®keyæŸ¥æ‰¾åˆ°å¯¹åº”çš„keyIndexï¼Œå†è¿›è¡Œç›¸å…³çš„æ“ä½œï¼Œæœ€åé‡æ–°å†™å…¥åˆ°btreeä¸­ã€‚

## store 

å‰é¢è®²åˆ°äº†WALæ•°æ®çš„å­˜å‚¨ã€å†…å­˜ç´¢å¼•æ•°æ®çš„å­˜å‚¨ï¼Œè¿™éƒ¨åˆ†è®¨è®ºæŒä¹…åŒ–å­˜å‚¨æ•°æ®çš„æ¨¡å—ã€‚

etcd V3ç‰ˆæœ¬ä¸­ï¼Œä½¿ç”¨BoltDBæ¥æŒä¹…åŒ–å­˜å‚¨æ•°æ®ï¼ˆetcd V2ç‰ˆæœ¬çš„å®ç°ä¸åšè®¨è®ºï¼‰ã€‚æ‰€ä»¥è¿™é‡Œå…ˆç®€å•è§£é‡Šä¸€ä¸‹BoltDBä¸­çš„ç›¸å…³æ¦‚å¿µã€‚

### BoltDBç›¸å…³æ¦‚å¿µ 

BoltDBä¸­æ¶‰åŠåˆ°çš„å‡ ä¸ªæ•°æ®ç»“æ„ï¼Œåˆ†åˆ«ä¸ºDBã€Bucketã€Txã€Cursorã€Txç­‰ã€‚

å…¶ä¸­ï¼š

-   DBï¼šè¡¨ç¤ºæ•°æ®åº“ï¼Œç±»æ¯”äºMysqlã€‚
-   Bucketï¼šæ•°æ®åº“ä¸­çš„é”®å€¼é›†åˆï¼Œç±»æ¯”äºMysqlä¸­çš„ä¸€å¼ æ•°æ®è¡¨ã€‚
-   é”®å€¼å¯¹ï¼šBoltDBä¸­å®é™…å­˜å‚¨çš„æ•°æ®ï¼Œç±»æ¯”äºMysqlä¸­çš„ä¸€è¡Œæ•°æ®ã€‚
-   Cursorï¼šè¿­ä»£å™¨ï¼Œç”¨äºæŒ‰é¡ºåºéå†Bucketä¸­çš„é”®å€¼å¯¹ã€‚
-   Txï¼šè¡¨ç¤ºæ•°æ®åº“æ“ä½œä¸­çš„ä¸€æ¬¡åªè¯»æˆ–è€…è¯»å†™äº‹åŠ¡ã€‚

### Backendä¸BackendTxæ¥å£ 

Backendå’ŒBackendTxå†…éƒ¨çš„å®ç°ï¼Œå°è£…äº†BoltDBï¼Œå¤ªç®€å•å°±ä¸åšåˆ†æäº†ã€‚

### Lessoræ¥å£ 

etcdä¸­æ²¡æœ‰æä¾›é’ˆå¯¹æ•°æ®è®¾ç½®è¿‡æœŸæ—¶é—´çš„æ“ä½œï¼Œé€šè¿‡ç§Ÿçº¦ï¼ˆLeaseï¼‰æ¥å®ç°æ•°æ®è¿‡æœŸçš„æ•ˆæœã€‚è€ŒLessoræ¥å£å°±æä¾›äº†ç®¡ç†ç§Ÿçº¦çš„ç›¸å…³æ¥å£ã€‚

æ¯”å¦‚ï¼Œä½¿ç”¨etcdctlå‘½ä»¤å¯ä»¥åˆ›å»ºä¸€ä¸ªleaseï¼š

```
etcdctl lease grant 10 lease 694d67ed2bfbea03 granted with TTL(10s)
```

è¿™æ ·å°±åˆ›å»ºäº†ä¸€ä¸ªIDä¸º694d67ed2bfbea03çš„Leaseï¼Œæ­¤æ—¶å¯ä»¥å°†é”®å€¼ä¸è¿™ä¸ªleaseè¿›è¡Œç»‘å®šï¼š

```
etcdctl put --lease=694d67ed2bfbea03 a b
```

å½“æ—¶é—´è¿˜æ²¡è¶…è¿‡è¿‡æœŸæ—¶é—´10Sæ—¶ï¼Œèƒ½é€šè¿‡etcdæ‹¿åˆ°è¿™å¯¹é”®å€¼çš„æ•°æ®ã€‚å¦‚æœè¶…æ—¶äº†å°±è·å–ä¸åˆ°æ•°æ®äº†ã€‚

ä»ä¸Šé¢çš„å‘½ä»¤å¯ä»¥çœ‹å‡ºï¼Œä¸€ä¸ªLeaseå¯ä»¥ä¸å¤šä¸ªé”®å€¼å¯¹åº”ï¼Œç”±è¿™ä¸ªLeaseé€šè¿‡ç®¡ç†ä¸å…¶ç»‘å®šçš„é”®å€¼æ•°æ®çš„ç”Ÿå‘½å‘¨æœŸã€‚

etcdä¸­ï¼Œå°†Lease IDå­˜æ”¾åœ¨åä¸ºâ€œleaseâ€çš„Bucketä¸­ï¼Œæ³¨æ„åœ¨è¿™é‡Œåªå­˜æ”¾Leaseç›¸å…³çš„æ•°æ®ï¼Œå…¶é”®å€¼ä¸ºï¼š<Lease IDï¼Œåºåˆ—åŒ–åçš„Leaseæ•°æ®åŒ…æ‹¬TTLã€ID>ï¼Œä¹‹æ‰€ä»¥ä¸å­˜æ”¾ä¸Leaseç»‘å®šçš„é”®å€¼ï¼Œæ˜¯å› ä¸ºè¿™äº›é”®å€¼å·²ç»å­˜æ”¾åˆ°å¦å¤–çš„Bucketé‡Œäº†ï¼Œå†™å…¥æ•°æ®çš„æ—¶å€™ä¹Ÿä¼šå°†è¿™äº›é”®å€¼ç»‘å®šçš„Lease IDå†™å…¥ï¼Œè¿™æ ·åœ¨æ¢å¤æ•°æ®çš„æ—¶å€™å°±å¯ä»¥å°†é”®å€¼ä¸Lease IDç»‘å®šçš„å…³ç³»å†™å…¥å†…å­˜ä¸­ã€‚

å³ï¼šLeaseè¿™è¾¹éœ€è¦æŒä¹…åŒ–çš„æ•°æ®åªæœ‰Lease IDä¸TTLå€¼ï¼Œè€Œé”®å€¼å¯¹è¿™è¾¹ä¼šæŒä¹…åŒ–æ‰€ç»‘å®šçš„Lease IDï¼Œè¿™æ ·åœ¨å¯åŠ¨æ¢å¤çš„æ—¶å€™å¯ä»¥å°†ä¸¤è€…å¯¹åº”çš„å…³ç³»æ¢å¤åˆ°å†…å­˜ä¸­ã€‚



![etcd lease_store](https://www.codedump.info/media/imgs/20181125-etcd-server/etcd-lease-store.png)

etcd lease store



æ˜ç™½äº†ä»¥ä¸Šå…³ç³»å†æ¥ç†è§£Lessorçš„å®ç°å°±å¾ˆç®€å•äº†ã€‚

lessorä¸­ä¸»è¦åŒ…æ‹¬ä»¥ä¸‹çš„æˆå‘˜ï¼š

-   leaseMap map[LeaseID]*Leaseï¼šå­˜å‚¨LeaseIDä¸Leaseå®ä¾‹ä¹‹é—´çš„å¯¹åº”å…³ç³»ã€‚
-   itemMap map[LeaseItem]LeaseIDï¼šleaseItemå®é™…å­˜æ”¾çš„æ˜¯é”®å€¼ï¼Œæ‰€ä»¥è¿™ä¸ªmapç®¡ç†çš„å°±æ˜¯é”®å€¼ä¸Lease IDä¹‹é—´çš„å¯¹åº”å…³ç³»ã€‚
-   b backend.Backendï¼šæŒä¹…åŒ–å­˜å‚¨ï¼Œæ¯ä¸ªLeaseçš„æŒä¹…åŒ–æ•°æ®ä¼šå†™å…¥åä¸ºâ€œleaseâ€çš„Bucketä¸­ã€‚
-   minLeaseTTL int64ï¼šæœ€å°è¿‡æœŸæ—¶é—´ï¼Œè®¾ç½®ç»™æ¯ä¸ªleaseçš„è¿‡æœŸæ—¶é—´ä¸å¾—å°äºè¿™ä¸ªæ•°æ®ã€‚
-   expiredC chan []*Leaseï¼šé€šè¿‡è¿™ä¸ªchannelé€šçŸ¥å¤–éƒ¨æœ‰å“ªäº›Leaseè¿‡æœŸäº†ã€‚

å…¶ä»–çš„å°±å¾ˆç®€å•äº†:

1.  lessorå¯åŠ¨ä¹‹åä¼šè¿è¡Œä¸€ä¸ªgoroutineåç¨‹ï¼Œåœ¨è¿™ä¸ªåç¨‹é‡Œå®šæœŸæŸ¥è¯¢å“ªäº›Leaseè¶…æ—¶ï¼Œè¶…æ—¶çš„Leaseå°†é€šè¿‡expiredC channelé€šçŸ¥å¤–éƒ¨ã€‚
2.  è€Œé’ˆå¯¹Leaseçš„CRUDæ“ä½œï¼Œéƒ½éœ€è¦è¿›è¡ŒåŠ é”æ‰èƒ½æ“ä½œã€‚

## KVæ¥å£ 

æœ‰äº†ä»¥ä¸Šçš„å‡†å¤‡ï¼Œå¯ä»¥å¼€å§‹åˆ†ææ•°æ®å­˜å‚¨ç›¸å…³çš„å†…å®¹äº†ã€‚åœ¨etcd V3ä¸­ï¼Œæ‰€æœ‰æ¶‰åŠåˆ°æ•°æ®çš„å­˜å‚¨ï¼Œéƒ½ä¼šé€šè¿‡KVæ¥å£ã€‚

storeç»“æ„ä½“å®ç°äº†KVæ¥å£ï¼Œå…¶ä¸­æœ€é‡è¦çš„å°±æ˜¯å°è£…äº†å‰é¢æåˆ°çš„å‡ ä¸ªæ•°æ®ç»“æ„ï¼š

-   b backend.Backendï¼šç”¨äºå°†æŒä¹…åŒ–æ•°æ®å†™å…¥BoltDBä¸­ã€‚
-   kvindex indexï¼šä¿å­˜keyç´¢å¼•ã€‚
-   changes []mvccpb.KeyValueï¼šä¿å­˜æ¯æ¬¡å†™æ“ä½œä¹‹åè¿›è¡Œäº†ä¿®æ”¹çš„æ•°æ®ï¼Œç”¨äºé€šçŸ¥watchäº†è¿™äº›æ•°æ®å˜æ›´çš„å®¢æˆ·ç«¯ã€‚

åœ¨storeç»“æ„ä½“åˆå§‹åŒ–æ—¶ï¼Œæ ¹æ®ä¼ å…¥çš„backend.Backendï¼Œåˆå§‹åŒ–backend.BatchTxç»“æ„ï¼Œåé¢çš„ä»»ä½•æ¶‰åŠåˆ°äº‹åŠ¡çš„æ“ä½œï¼Œéƒ½å¯ä»¥é€šè¿‡è¿™ä¸ªbackend.BatchTxæ¥è¿›è¡Œã€‚

å…¶å®æœ‰äº†å‰é¢çš„å‡†å¤‡ï¼Œç†è§£storeç»“æ„åšçš„äº‹æƒ…å·²ç»ä¸éš¾ï¼Œä»¥ä¸€æ¬¡Putæ“ä½œä¸ºä¾‹ï¼Œå…¶æµç¨‹ä¸»è¦å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š



![etcd store_put](https://www.codedump.info/media/imgs/20181125-etcd-server/etcd-store-put.png)

etcd store put



# applierV3 

EtcdServerå†…éƒ¨å®ç°ä¸­ï¼Œå®é™…ä½¿ç”¨çš„æ˜¯applierV3æ¥å£æ¥è¿›è¡ŒæŒä¹…åŒ–æ•°æ®çš„æ“ä½œã€‚

è¿™ä¸ªæ¥å£æœ‰ä»¥ä¸‹å‡ ä¸ªå®ç°ï¼Œä½†æ˜¯å…¶ä¸­applierV3backendçš„å®ç°æ˜¯æœ€é‡è¦çš„ï¼Œå…¶å†…éƒ¨ä½¿ç”¨äº†å‰é¢æåˆ°çš„KVæ¥å£æ¥è¿›è¡Œæ•°æ®çš„å¤„ç†ã€‚

å¦å¤–ï¼ŒapplierV3æ¥å£è¿˜æœ‰å…¶ä»–å‡ ä¸ªå®ç°ï¼Œè¿™é‡Œåˆ†åˆ«åˆ—ä¸¾ä¸€ä¸‹ã€‚

-   applierV3backendï¼šåŸºç¡€çš„applierV3æ¥å£å®ç°ï¼Œå…¶ä»–å‡ ä¸ªå®ç°éƒ½åœ¨æ­¤å®ç°ä¸ŠåšåŠŸèƒ½æ‰©å±•ã€‚å†…éƒ¨è°ƒç”¨EtcdServerä¸­çš„KVæ¥å£è¿›è¡ŒæŒä¹…åŒ–æ•°æ®è¯»å†™æ“ä½œã€‚
-   applierV3Cappedï¼šç£ç›˜ç©ºé—´ä¸è¶³çš„æƒ…å†µä¸‹ï¼ŒEtcdServerä¸­çš„applierV3åˆ‡æ¢åˆ°è¿™ä¸ªå®ç°é‡Œé¢æ¥ï¼Œè¿™ä¸ªå®ç°çš„ä»»ä½•å†™å…¥æ“ä½œéƒ½ä¼šå¤±è´¥ï¼Œè¿™æ ·ä¿è¯åº•å±‚å­˜å‚¨çš„æ•°æ®é‡ä¸å†å¢åŠ ã€‚
-   authApplierV3ï¼šåœ¨applierV3backendçš„åŸºç¡€ä¸Šæ‰©å±•å‡ºæƒé™æ§åˆ¶çš„åŠŸèƒ½ã€‚
-   quotaApplierV3ï¼šåœ¨applierV3backendçš„åŸºç¡€ä¸ŠåŠ ä¸Šäº†é™æµåŠŸèƒ½ï¼Œå³åº•å±‚çš„å­˜å‚¨åˆ°äº†ä¸Šé™çš„è¯ï¼Œä¼šè§¦å‘é™æµæ“ä½œã€‚

# ç»¼è¿° 

ä¸‹å›¾å°†ä¸Šé¢æ¶‰åŠåˆ°çš„å…³é”®æ•°æ®ç»“æ„ä¸²è”åœ¨ä¸€èµ·ï¼Œçœ‹çœ‹EtcdServeråœ¨æ”¶åˆ°Raftåº“é€šè¿‡Ready channelé€šçŸ¥çš„å¯ä»¥æŒä¹…åŒ–æ•°æ®ä¹‹åï¼Œéƒ½åšäº†ä»€ä¹ˆæ“ä½œã€‚



![etcd raft_flow](https://www.codedump.info/media/imgs/20181125-etcd-server/etcd-raft-flow.png)

etcd raft flow



1.  raftåº“é€šè¿‡Ready Channelé€šçŸ¥ä¸Šå±‚çš„raftNodeå“ªäº›æ•°æ®å¯ä»¥è¿›è¡ŒæŒä¹…åŒ–ã€‚
2.  raftNodeå¯åŠ¨ä¹‹åä¹Ÿæ˜¯ä¼šå¯åŠ¨ä¸€ä¸ªGoroutineæ¥ä¸€ç›´ç›‘å¬è¿™ä¸ªReady Channelï¼Œä»¥ä¾¿æ”¶åˆ°å¯ä»¥æŒä¹…åŒ–æ•°æ®çš„é€šçŸ¥ã€‚
3.  raftNodeåœ¨æ”¶åˆ°Readyæ•°æ®ä¹‹åï¼Œå°†é¦–å…ˆå†™å…¥WALæ—¥å¿—ä¸­ã€‚è¿™é‡Œçš„WALæ—¥å¿—ç”±storageç»“æ„ä½“æ¥ç®¡ç†ï¼Œåˆ†ä¸ºä¸¤å¤§éƒ¨åˆ†ï¼šWALæ—¥å¿—ä»¥åŠWALå¿«ç…§æ–‡ä»¶æ•°æ®Snapshotterï¼Œåè€…ç”¨æ¥é¿å…WALæ–‡ä»¶ä¸€ç›´å¢å¤§ã€‚
4.  raftNodeåœ¨å†™WALæ•°æ®å®Œæˆä¹‹åï¼Œé€šè¿‡apply Channelé€šçŸ¥EtcdServerã€‚
5.  EtcdServerå¯åŠ¨ä¹‹åä¹Ÿæ˜¯å¯åŠ¨ä¸€ä¸ªGoroutineæ¥ç›‘å¬è¿™ä¸ªchannelï¼Œä»¥ä¾¿æ”¶åˆ°å¯ä»¥æŒä¹…åŒ–æ•°æ®çš„é€šçŸ¥ã€‚
6.  EtcdServeré€šè¿‡è°ƒç”¨applierV3æ¥å£æ¥æŒä¹…åŒ–æ•°æ®ã€‚applierV3backendç»“æ„ä½“å®ç°applierV3æ¥å£, applierV3backendç»“æ„ä½“å®ç°applierV3æ¥å£ï¼Œå†…éƒ¨é€šè¿‡è°ƒç”¨KVæ¥å£è¿›è¡ŒæŒä¹…åŒ–æ“ä½œã€‚è€Œåœ¨å®ç°KVæ¥å£çš„storeç»“æ„ä½“ä¸­ï¼ŒtreeIndexè´Ÿè´£åœ¨å†…å­˜ä¸­ç»´æŠ¤æ•°æ®é”®å€¼ä¸revisionçš„å¯¹åº”å…³ç³»å³keyIndexæ•°æ®ï¼ŒBackendæ¥å£è´Ÿè´£æŒä¹…åŒ–æ•°æ®ï¼Œæœ€åæŒä¹…åŒ–çš„æ•°æ®å°†è½ç›˜åˆ°BoltDBä¸­ã€‚



```bash
go.etcd.io/etcd/embed.Config {
        Name: "default",
        Dir: "default.etcd",
        WalDir: "",
        SnapshotCount: 100000,
        SnapshotCatchUpEntries: 5000,
        MaxSnapFiles: 5,
        MaxWalFiles: 5,
        TickMs: 100,
        ElectionMs: 1000,
        InitialElectionTickAdvance: true,
        BackendBatchInterval: 0,
        BackendBatchLimit: 0,
        QuotaBackendBytes: 0,
        MaxTxnOps: 128,
        MaxRequestBytes: 1572864,
        LPUrls: []net/url.URL len: 1, cap: 1, [
                (*"net/url.URL")(0xc0001f0990),
        ],
        LCUrls: []net/url.URL len: 1, cap: 1, [
                (*"net/url.URL")(0xc0001f0c60),
        ],
        APUrls: []net/url.URL len: 1, cap: 1, [
               (*"net/url.URL")(0xc0001f0fc0),
        ],
        ACUrls: []net/url.URL len: 1, cap: 1, [
                (*"net/url.URL")(0xc0001f1290),
        ],
        ClientTLSInfo: go.etcd.io/etcd/pkg/transport.TLSInfo {
                CertFile: "",
                KeyFile: "",
                TrustedCAFile: "",
                ClientCertAuth: false,
                CRLFile: "",
                InsecureSkipVerify: false,
                SkipClientSANVerify: false,
                ServerName: "",
                HandshakeFailure: go.etcd.io/etcd/embed.logTLSHandshakeFailure,
                CipherSuites: []uint16 len: 0, cap: 0, nil,
                selfCert: false,
                parseFunc: nil,
                AllowedCN: "",
                AllowedHostname: "",
                Logger: *go.uber.org/zap.Logger nil,
                EmptyCN: false,},
        ClientAutoTLS: false,
        PeerTLSInfo: go.etcd.io/etcd/pkg/transport.TLSInfo {
                CertFile: "",
                KeyFile: "",
                TrustedCAFile: "",
                ClientCertAuth: false,
                CRLFile: "",
                InsecureSkipVerify: false,
                SkipClientSANVerify: false,
                ServerName: "",
                HandshakeFailure: go.etcd.io/etcd/embed.logTLSHandshakeFailure,
                CipherSuites: []uint16 len: 0, cap: 0, nil,
                selfCert: false,
                parseFunc: nil,
               AllowedCN: "",
                AllowedHostname: "",
                Logger: *go.uber.org/zap.Logger nil,
                EmptyCN: false,},
        PeerAutoTLS: false,
        CipherSuites: []string len: 0, cap: 0, [],
        ClusterState: "new",
        DNSCluster: "",
        DNSClusterServiceName: "",
        Dproxy: "",
        Durl: "",
        InitialCluster: "default=http://localhost:2380",
        InitialClusterToken: "etcd-cluster",
        StrictReconfigCheck: true,
        EnableV2: false,
        AutoCompactionMode: "periodic",
        AutoCompactionRetention: "0",
        GRPCKeepAliveMinTime: go.etcd.io/etcd/clientv3.defaultTTL (5000000000),
        GRPCKeepAliveInterval: google.golang.org/grpc/internal/transport.defaultPingTimeout (7200000000000),
        GRPCKeepAliveTimeout: google.golang.org/grpc/internal/transport.defaultServerKeepaliveTimeout (20000000000),
        PreVote: false,
        CORS: map[string]struct {} [
                "*": {}, 
        ],
        HostWhitelist: map[string]struct {} [
                "*": {}, 
        ],
        UserHandlers: map[string]net/http.Handler nil,
        ServiceRegister: nil,
        AuthToken: "simple",
        BcryptCost: 10,
        ExperimentalInitialCorruptCheck: false,
        ExperimentalCorruptCheckTime: 0,
        ExperimentalEnableV2V3: "",
        ExperimentalBackendFreelistType: "",
        ExperimentalEnableLeaseCheckpoint: false,
				ExperimentalCompactionBatchLimit: 0,
        ForceNewCluster: false,
        EnablePprof: false,
        Metrics: "basic",
        ListenMetricsUrls: []net/url.URL len: 0, cap: 0, nil,
        ListenMetricsUrlsJSON: "",
        Logger: "capnslog",
        LogLevel: "info",
        LogOutputs: []string len: 1, cap: 1, ["default"],
        zapLoggerBuilder: nil,
        loggerMu: *sync.RWMutex {
                w: (*sync.Mutex)(0xc00003a540),
                writerSem: 0,
                readerSem: 0,
                readerCount: (*"sync/atomic.Int32")(0xc00003a550),
				readerWait: (*"sync/atomic.Int32")(0xc00003a554),},
        logger: *go.uber.org/zap.Logger nil,
        loggerConfig: *go.uber.org/zap.Config nil,
        loggerCore: go.uber.org/zap/zapcore.Core nil,
        loggerWriteSyncer: go.uber.org/zap/zapcore.WriteSyncer nil,
        EnableGRPCGateway: true,
        DeprecatedLogOutput: []string len: 1, cap: 1, ["default"],
        Debug: false,
        LogPkgLevels: "",
}
```

è°ƒè¯•

å®¢æˆ·ç«¯

```bash
$ etcd git:(v3.4.0) âœ— ./bin/etcdctl put name gc
{"level":"warn","ts":"2025-08-01T16:22:40.406+0800","caller":"clientv3/retry_interceptor.go:61","msg":"retrying of unary invoker failed","target":"endpoint://client-1cd6df65-3ed0-4025-b7a2-fc7ccd589833/127.0.0.1:2379","attempt":0,"error":"rpc error: code = DeadlineExceeded desc = context deadline exceeded"}
Error: context deadline exceeded
```

æœåŠ¡ç«¯

```bash
 0  0x00000000010f00d3 in go.etcd.io/etcd/etcdserver/api/v3rpc.(*kvServer).Put
    at ./etcdserver/api/v3rpc/key.go:61
 1  0x00000000010f8a82 in go.etcd.io/etcd/etcdserver/api/v3rpc.(*quotaKVServer).Put
    at ./etcdserver/api/v3rpc/quota.go:63
 2  0x0000000000cfce31 in go.etcd.io/etcd/etcdserver/etcdserverpb._KV_Put_Handler.func1
    at ./etcdserver/etcdserverpb/rpc.pb.go:3570
 3  0x00000000010dd6d3 in github.com/grpc-ecosystem/go-grpc-middleware.ChainUnaryServer.func1.1
    at /home/gc/go/pkg/mod/github.com/grpc-ecosystem/go-grpc-middleware@v1.0.1-0.20190118093823-f849b5445de4/chain.go:31
 4  0x00000000010e2185 in github.com/grpc-ecosystem/go-grpc-prometheus.(*ServerMetrics).UnaryServerInterceptor.func1
    at /home/gc/go/pkg/mod/github.com/grpc-ecosystem/go-grpc-prometheus@v1.2.0/server_metrics.go:107
 5  0x00000000010dd805 in github.com/grpc-ecosystem/go-grpc-middleware.ChainUnaryServer.func1.1
    at /home/gc/go/pkg/mod/github.com/grpc-ecosystem/go-grpc-middleware@v1.0.1-0.20190118093823-f849b5445de4/chain.go:34
 6  0x00000000010ecdaa in go.etcd.io/etcd/etcdserver/api/v3rpc.newUnaryInterceptor.func1
    at ./etcdserver/api/v3rpc/interceptor.go:64
 7  0x00000000010dd805 in github.com/grpc-ecosystem/go-grpc-middleware.ChainUnaryServer.func1.1
    at /home/gc/go/pkg/mod/github.com/grpc-ecosystem/go-grpc-middleware@v1.0.1-0.20190118093823-f849b5445de4/chain.go:34
 8  0x00000000010ed03e in go.etcd.io/etcd/etcdserver/api/v3rpc.newLogUnaryInterceptor.func1
    at ./etcdserver/api/v3rpc/interceptor.go:71
 9  0x00000000010dd4da in github.com/grpc-ecosystem/go-grpc-middleware.ChainUnaryServer.func1
    at /home/gc/go/pkg/mod/github.com/grpc-ecosystem/go-grpc-middleware@v1.0.1-0.20190118093823-f849b5445de4/chain.go:39
10  0x0000000000cfcb0c in go.etcd.io/etcd/etcdserver/etcdserverpb._KV_Put_Handler
    at ./etcdserver/etcdserverpb/rpc.pb.go:3572
11  0x0000000000cb3306 in google.golang.org/grpc.(*Server).processUnaryRPC
		at /home/gc/go/pkg/mod/google.golang.org/grpc@v1.23.0/server.go:995
12  0x0000000000cb7dd8 in google.golang.org/grpc.(*Server).handleStream
    at /home/gc/go/pkg/mod/google.golang.org/grpc@v1.23.0/server.go:1275
13  0x0000000000cb02fb in google.golang.org/grpc.(*Server).serveStreams.func1.1
    at /home/gc/go/pkg/mod/google.golang.org/grpc@v1.23.0/server.go:710
14  0x0000000000483261 in runtime.goexit
    at /usr/local/go/src/runtime/asm_amd64.s:1695

```



