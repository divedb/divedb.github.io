---
date: 2025-07-27
layout: post
title: æŠ€æœ¯èƒŒæ™¯ã€ç¬¬äºŒç« ã€‘
categories: Linux
tags: [Linux, BPF] 
---

ç¬¬1ç« ä»‹ç»äº†BPFæ€§èƒ½å·¥å…·æ‰€æ¶‰åŠçš„å„ç§æŠ€æœ¯ï¼Œè€Œæœ¬ç« å°†å¯¹å®ƒä»¬è¿›è¡Œæ›´æ·±å…¥çš„è®²è§£ï¼ŒåŒ…æ‹¬å®ƒä»¬çš„å†å²ã€æ¥å£ã€å†…éƒ¨æœºåˆ¶ï¼Œä»¥åŠä¸`BPF`çš„ç»“åˆä½¿ç”¨ã€‚

æœ¬ç« æ˜¯å…¨ä¹¦ä¸­æŠ€æœ¯æ·±åº¦æœ€é«˜çš„ä¸€ç« ã€‚ä¸ºäº†ç®€æ´èµ·è§ï¼Œå†…å®¹é»˜è®¤ä½ å·²å…·å¤‡ä¸€å®šçš„å†…æ ¸å†…éƒ¨ç»“æ„å’ŒæŒ‡ä»¤çº§ç¼–ç¨‹æ–¹é¢çš„çŸ¥è¯†ã€‚

æœ¬ç« çš„å­¦ä¹ ç›®æ ‡å¹¶ä¸æ˜¯è¦ä½ æ­»è®°ç¡¬èƒŒæ¯ä¸€é¡µå†…å®¹ï¼Œè€Œæ˜¯å¸Œæœ›ä½ èƒ½å¤Ÿï¼š

-   ç†è§£`BPF`çš„èµ·æºï¼Œä»¥åŠæ‰©å±•`BPF`ï¼ˆ`eBPF`ï¼‰åœ¨ä»Šå¤©çš„ä½œç”¨ï¼›
-   æŒæ¡æ ˆå¸§æŒ‡é’ˆéå†ï¼ˆ`frame pointer stack walking`ï¼‰ç­‰å¸¸ç”¨æŠ€æœ¯ï¼›
-   ç†è§£ç«ç„°å›¾ï¼ˆ`flame graph`ï¼‰çš„æ„æˆä¸åˆ†ææ–¹æ³•ï¼›
-   æŒæ¡`kprobe`å’Œ`uprobe`çš„ç”¨æ³•ï¼ŒåŠå…¶ç¨³å®šæ€§ç›¸å…³çš„æ³¨æ„äº‹é¡¹ï¼›
-   ç†è§£`tracepoint`ã€`USDT`æ¢é’ˆå’ŒåŠ¨æ€`USDT`çš„è§’è‰²ï¼›
-   äº†è§£æ€§èƒ½ç›‘æ§è®¡æ•°å™¨ï¼ˆ`PMC`ï¼‰ä»¥åŠå®ƒä»¬å¦‚ä½•ç»“åˆ`BPF`ä½¿ç”¨ï¼›
-   æŒæ¡ä¸€äº›é¢å‘æœªæ¥çš„å‘å±•æ–¹å‘ï¼šå¦‚`BTF`ä»¥åŠå…¶å®ƒ`BPF`æ ˆéå†å™¨ã€‚

ç†è§£æœ¬ç« å°†å¸®åŠ©ä½ æ›´æ·±å…¥åœ°æŒæ¡æœ¬ä¹¦åç»­å†…å®¹ã€‚ä½†å¦‚æœä½ æ­¤åˆ»åªæ˜¯æƒ³å¿«é€Ÿä¸Šæ‰‹`BPF`å·¥å…·æ¥è§£å†³å®é™…é—®é¢˜ï¼Œä¹Ÿå¯ä»¥å…ˆç•¥è¯»æœ¬ç« ï¼Œå¾…éœ€è¦æ—¶å†å›æ¥æ·±å…¥å­¦ä¹ ã€‚

ç¬¬3ç« å°†æ­£å¼å¸¦ä½ å¼€å§‹ä½¿ç”¨`BPF`å·¥å…·ï¼Œå¯»æ‰¾ç³»ç»Ÿä¸­çš„æ€§èƒ½ä¼˜åŒ–æœºä¼šã€‚

##### ğŸŒ² `BPF`æŠ€æœ¯å…³ç³»å›¾

å›¾2-1å±•ç¤ºäº†æœ¬ç« æ¶‰åŠçš„å¤šé¡¹`BPF`ç›¸å…³æŠ€æœ¯åŠå®ƒä»¬ä¹‹é—´çš„å…³ç³»ã€‚

![](/assets/img/linux/bpf/figure2-1.png)

##### ğŸŒ² `BPF`

`BPF`ï¼ˆ`Berkeley Packet Filter`ï¼‰æœ€åˆæ˜¯åœ¨`BSD`æ“ä½œç³»ç»Ÿä¸Šå¼€å‘çš„ï¼Œé¦–æ¬¡å‘è¡¨äº1992å¹´çš„è®ºæ–‡ã€Š`The BSD Packet Filter: A New Architecture for User-level Packet Capture`ã€‹[McCanne 92]ã€‚è¯¥è®ºæ–‡åœ¨1993å¹´ç¾å›½åœ£åœ°äºšå“¥å¬å¼€çš„`USENIX`å†¬å­£ä¼šè®®ä¸Šå‘è¡¨ï¼ŒåŒæœŸè¿˜æœ‰ã€Š`Measurement, Analysis, and Improvement of UDP/IP Throughput for the DECstation 5000`ã€‹ã€‚è™½ç„¶`DECstation`æ—©å·²æˆä¸ºå†å²ï¼Œä½†`BPF`å´å¾—ä»¥å»¶ç»­ï¼Œå¹¶æˆä¸ºä¸šç•Œæ ‡å‡†çš„åŒ…è¿‡æ»¤è§£å†³æ–¹æ¡ˆã€‚

`BPF`çš„å·¥ä½œåŸç†éå¸¸æœ‰è¶£ï¼šç”¨æˆ·é€šè¿‡å®šä¹‰ä¸€æ®µé’ˆå¯¹`BPF`è™šæ‹Ÿæœºçš„æŒ‡ä»¤é›†ï¼ˆé€šå¸¸ç§°ä¸º`BPF`å­—èŠ‚ç ï¼‰æ¥æè¿°è¿‡æ»¤é€»è¾‘ï¼Œç„¶åå°†è¿™æ®µæŒ‡ä»¤ä¼ é€’ç»™å†…æ ¸ï¼Œç”±å†…æ ¸ä¸­çš„è§£é‡Šå™¨æ‰§è¡Œã€‚è¿™æ ·ä¸€æ¥ï¼ŒåŒ…è¿‡æ»¤çš„è¿‡ç¨‹å¯ä»¥ç›´æ¥åœ¨å†…æ ¸æ€å®Œæˆï¼Œé¿å…äº†å°†æ¯ä¸ªæ•°æ®åŒ…æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´çš„é«˜æ˜‚å¼€é”€ï¼Œä»è€Œæå¤§æå‡äº†åƒ`tcpdump(8)`è¿™æ ·çš„å·¥å…·çš„æ€§èƒ½ã€‚

æ›´é‡è¦çš„æ˜¯ï¼Œè¿™ç§æœºåˆ¶ä¹Ÿå…·å¤‡äº†å®‰å…¨æ€§ï¼šæ¥è‡ªç”¨æˆ·ç©ºé—´çš„`BPF`ç¨‹åºå¯ä»¥åœ¨æ‰§è¡Œå‰è¢«å†…æ ¸éªŒè¯ä¸ºâ€œå®‰å…¨â€ã€‚å› ä¸ºæ—©æœŸçš„åŒ…è¿‡æ»¤éœ€è¦åœ¨å†…æ ¸ä¸­å®Œæˆï¼Œå› æ­¤å®‰å…¨æ€§æ˜¯ä¸€é¡¹ç¡¬æ€§è¦æ±‚ã€‚

å›¾2-2å±•ç¤ºäº†è¿™ä¸€å·¥ä½œæœºåˆ¶çš„æµç¨‹ã€‚

![](/assets/img/linux/bpf/figure2-2.png)

ä½ å¯ä»¥ä½¿ç”¨`tcpdump(8)`çš„`-d`é€‰é¡¹æ¥æ‰“å°å…¶ä½¿ç”¨çš„`BPF`æŒ‡ä»¤ï¼Œä»¥æŸ¥çœ‹å®ƒæ˜¯å¦‚ä½•å¤„ç†è¿‡æ»¤è¡¨è¾¾å¼çš„ã€‚ä¾‹å¦‚ï¼š

```bash
$ tcpdump -d host 127.0.0.1 and port 80
Warning: assuming Ethernet
(000) ldh      [12]
(001) jeq      #0x800           jt 2	jf 18
(002) ld       [26]
(003) jeq      #0x7f000001      jt 6	jf 4
(004) ld       [30]
(005) jeq      #0x7f000001      jt 6	jf 18
(006) ldb      [23]
(007) jeq      #0x84            jt 10	jf 8
(008) jeq      #0x6             jt 10	jf 9
(009) jeq      #0x11            jt 10	jf 18
(010) ldh      [20]
(011) jset     #0x1fff          jt 18	jf 12
(012) ldxb     4*([14]&0xf)
(013) ldh      [x + 14]
(014) jeq      #0x50            jt 17	jf 15
(015) ldh      [x + 16]
(016) jeq      #0x50            jt 17	jf 18
(017) ret      #262144
(018) ret      #0
```

åŸå§‹çš„`BPF`ï¼ˆç°åœ¨é€šå¸¸ç§°ä¸ºâ€œç»å…¸`BPF`â€ï¼‰æ˜¯ä¸€ä¸ªåŠŸèƒ½å—é™çš„è™šæ‹Ÿæœºã€‚å®ƒåªæœ‰ä¸¤ä¸ªå¯„å­˜å™¨ã€ä¸€ä¸ªç”±16ä¸ªå†…å­˜æ§½ç»„æˆçš„ä¸´æ—¶å†…å­˜åŒºåŸŸï¼ˆ`scratch memory`ï¼‰å’Œä¸€ä¸ªç¨‹åºè®¡æ•°å™¨ï¼ˆ`PC`ï¼‰ã€‚è¿™äº›å¯„å­˜å™¨å…¨éƒ½åŸºäº32ä½æ“ä½œã€‚ç»å…¸`BPF`äº1997å¹´è¢«å¼•å…¥`Linux`å†…æ ¸ï¼Œä» 2.1.75ç‰ˆæœ¬å¼€å§‹ã€‚

éšç€`BPF`è¢«é›†æˆè¿›`Linux`å†…æ ¸ï¼Œå®ƒé€æ­¥å¾—åˆ°äº†å¤šä¸ªé‡è¦çš„æ”¹è¿›ï¼š

-   2011å¹´7æœˆï¼Œ`Eric Dumazet`åœ¨`Linux 3.0`ä¸­åŠ å…¥äº†`BPF`çš„å³æ—¶ç¼–è¯‘å™¨ï¼ˆ`JIT`ï¼‰ï¼Œä½¿å…¶ç›¸è¾ƒäºè§£é‡Šæ‰§è¡Œè·å¾—äº†æ€§èƒ½æå‡ã€‚
-   2012å¹´ï¼Œ`Will Drewry`å°†`BPF`åº”ç”¨äº`seccomp`ï¼ˆå®‰å…¨è®¡ç®—ï¼‰ç³»ç»Ÿè°ƒç”¨ç­–ç•¥ä¸­ï¼Œè¿™æ ‡å¿—ç€`BPF`é¦–æ¬¡è¢«ç”¨äºç½‘ç»œä»¥å¤–çš„åœºæ™¯ï¼Œå¹¶å±•ç¤ºäº†å®ƒä½œä¸ºé€šç”¨æ‰§è¡Œå¼•æ“çš„æ½œåŠ›ã€‚

##### ğŸŒ² æ‰©å±•`BPF`ï¼ˆ`eBPF`ï¼‰

æ‰©å±•`BPF`ï¼ˆ`eBPF`ï¼‰æœ€åˆç”±**Alexei Starovoitov**åœ¨`PLUMgrid`å·¥ä½œæœŸé—´æå‡ºï¼Œå½“æ—¶è¯¥å…¬å¸æ­£åœ¨æ¢ç´¢æ„å»ºè½¯ä»¶å®šä¹‰ç½‘ç»œï¼ˆ`SDN`ï¼‰çš„æ–°æ–¹å¼ã€‚è¿™é¡¹æè®®æ˜¯å¯¹`BPF`è¿‘20å¹´æ¥çš„ç¬¬ä¸€æ¬¡é‡å¤§æ›´æ–°ï¼Œç›®æ ‡æ˜¯å°†`BPF`æ‰©å±•ä¸ºä¸€ä¸ªé€šç”¨è™šæ‹Ÿæœºã€‚

å½“è¯¥ææ¡ˆå°šå¤„äºè‰æ¡ˆé˜¶æ®µæ—¶ï¼Œæ¥è‡ª`Red Hat`çš„å†…æ ¸å¼€å‘è€…**Daniel Borkmann**ååŠ©å¯¹å…¶è¿›è¡Œäº†é‡æ„ï¼Œä½¿å…¶èƒ½è¢«æ¥å—è¿›å…¥å†…æ ¸ä¸»çº¿ï¼Œä½œä¸ºç°æœ‰`BPF`çš„æ›¿ä»£å®ç°ã€‚è¿™ä¸€æ‰©å±•`BPF`ç‰ˆæœ¬æœ€ç»ˆè¢«æˆåŠŸå¹¶å…¥ä¸»çº¿ï¼Œå¹¶éšåå¾—åˆ°äº†ä¼—å¤šå¼€å‘è€…çš„è´¡çŒ®ã€‚

`eBPF`çš„å…³é”®æ”¹è¿›åŒ…æ‹¬ï¼š

-   å¢åŠ äº†æ›´å¤šå¯„å­˜å™¨ï¼›
-   å°†å­—é•¿ä»32ä½æå‡åˆ°64ä½ï¼›
-   å¼•å…¥äº†çµæ´»çš„`BPF`â€œæ˜ å°„â€ï¼ˆ`map`ï¼‰æœºåˆ¶ç”¨äºæ•°æ®å­˜å‚¨ï¼›
-   å…è®¸è°ƒç”¨éƒ¨åˆ†å—é™çš„å†…æ ¸å‡½æ•°ï¼›
-   `JIT`ç¼–è¯‘å™¨å¯å°†`eBPF`ç¨‹åºä¸€ä¸€æ˜ å°„ä¸ºæœ¬åœ°æŒ‡ä»¤å’Œå¯„å­˜å™¨ï¼Œä»è€Œå¤ç”¨åŸæœ¬ä¸ºåŸç”Ÿä»£ç ä¼˜åŒ–çš„æŠ€æœ¯ï¼›
-   åŒæ—¶ï¼Œ`BPF`æ ¡éªŒå™¨ï¼ˆ`verifier`ï¼‰ä¹Ÿå¾—åˆ°äº†å¢å¼ºï¼Œä»¥æ”¯æŒè¿™äº›æ‰©å±•å¹¶æ‹’ç»ä»»ä½•ä¸å®‰å…¨çš„ä»£ç ã€‚

è¡¨2-1å±•ç¤ºäº†ç»å…¸`BPF`ä¸æ‰©å±•`BPF`ä¹‹é—´çš„ä¸»è¦å·®å¼‚ã€‚

| Factor                  | Classic BPF                | Extended BPF                                                 |
| ----------------------- | -------------------------- | ------------------------------------------------------------ |
| Register count          | 2: A, X                    | 10: R0â€“R9, plus R10 as a read-only frame pointer             |
| Register width          | 32-bit                     | 64-bit                                                       |
| Storage                 | 16 memory slots: M[0â€“15]   | 512 bytes of stack space, plus infinite "map" storage        |
| Restricted kernel calls | Very limited, JIT specific | Yes, via the bpf_call instruction                            |
| Event targets           | Packets, seccomp-BPF       | Packets, kernel functions, user functions, tracepoints, user markers, PMCs |

`Alexei`æœ€åˆçš„è¡¥ä¸é›†å‘å¸ƒäº2013å¹´9æœˆï¼Œæ ‡é¢˜ä¸ºâ€œextended BPFâ€ã€‚åˆ°2013å¹´12æœˆï¼Œä»–å·²å¼€å§‹æè®®å°†å…¶ç”¨äºè¿½è¸ªè¿‡æ»¤å™¨ã€‚ç»è¿‡ä¸`Daniel`çš„åå¤è®¨è®ºä¸å¼€å‘ï¼Œè¿™äº›è¡¥ä¸ä»2014å¹´3æœˆå¼€å§‹åˆå¹¶è¿›`Linux`ä¸»çº¿å†…æ ¸ã€‚

-   `JIT`ç›¸å…³ç»„ä»¶åˆå¹¶äº`Linux 3.15`ï¼ˆ2014å¹´6æœˆå‘å¸ƒï¼‰ï¼›
-   æ§åˆ¶`BPF`çš„ç³»ç»Ÿè°ƒç”¨`bpf(2)`åˆå¹¶äº`Linux 3.18`ï¼ˆ2014å¹´12æœˆå‘å¸ƒï¼‰ï¼›
-   åœ¨åç»­çš„`Linux 4.x`ç³»åˆ—ä¸­ï¼Œ`BPF`åˆé™†ç»­åŠ å…¥äº†å¯¹`kprobes`ã€`uprobes`ã€`tracepoints`å’Œ`perf_events`çš„æ”¯æŒã€‚

åœ¨æœ€åˆçš„è¡¥ä¸é›†ä¸­ï¼Œè¿™é¡¹æŠ€æœ¯æ›¾è¢«ç®€ç§°ä¸º**eBPF**ï¼Œä½†`Alexei`åæ¥ç»Ÿä¸€ç§°ä¹‹ä¸º**BPF**ã€‚ç›®å‰åœ¨`net-dev`é‚®ä»¶åˆ—è¡¨ä¸­ï¼Œæ‰€æœ‰`BPF`ç›¸å…³å¼€å‘ä¹Ÿéƒ½ä»¥â€œBPFâ€æ¥ç§°å‘¼å®ƒã€‚

`Linux`ä¸­`BPF`è¿è¡Œæ—¶çš„æ¶æ„å¦‚å›¾2-3æ‰€ç¤ºã€‚`BPF`ç¨‹åºåœ¨æ‰§è¡Œå‰ä¼šç»è¿‡**BPF æ ¡éªŒå™¨ï¼ˆverifierï¼‰**çš„æ£€æŸ¥ï¼Œä¹‹åå†ç”±`BPF`è™šæ‹Ÿæœºæ‰§è¡Œã€‚`BPF`è™šæ‹Ÿæœºæœ¬èº«æ—¢å¯ä»¥è§£é‡Šæ‰§è¡Œï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨`JIT`ç¼–è¯‘å™¨å°†å…¶è½¬ä¸ºæœ¬åœ°æŒ‡ä»¤ç›´æ¥è¿è¡Œã€‚

![](/assets/img/linux/bpf/figure2-3.png)

æ ¡éªŒå™¨çš„ä¸€ä¸ªé‡è¦èŒè´£æ˜¯æ‹’ç»ä¸å®‰å…¨çš„æ“ä½œï¼ˆå¦‚æ— é™å¾ªç¯ï¼‰ï¼Œå› ä¸º`BPF`ç¨‹åºå¿…é¡»åœ¨**æœ‰é™æ—¶é—´**å†…å®Œæˆæ‰§è¡Œã€‚æ­¤å¤–ï¼Œ`BPF`è¿˜èƒ½é€šè¿‡`helper`å‡½æ•°è®¿é—®å†…æ ¸çŠ¶æ€ï¼Œå¹¶ä½¿ç”¨`BPF map`è¿›è¡ŒçŠ¶æ€å­˜å‚¨ã€‚

`BPF`ç¨‹åºçš„æ‰§è¡Œé€šå¸¸æ˜¯ç”±æŸäº›äº‹ä»¶è§¦å‘çš„ï¼Œä¾‹å¦‚ï¼š

-   `kprobes`ï¼ˆå†…æ ¸å‡½æ•°å…¥å£/å‡ºå£ï¼‰
-   `uprobes`ï¼ˆç”¨æˆ·ç©ºé—´å‡½æ•°å…¥å£/å‡ºå£ï¼‰
-   `tracepoints`ï¼ˆå†…æ ¸é¢„å®šä¹‰åŸ‹ç‚¹ï¼‰

æ¥ä¸‹æ¥çš„å°èŠ‚å°†ä»‹ç»ï¼š

-   æ€§èƒ½å·¥å…·ä¸ºä»€ä¹ˆéœ€è¦`BPF`ï¼›
-   `eBPF`ç¼–ç¨‹çš„æ–¹å¼ï¼›
-   å¦‚ä½•æŸ¥çœ‹`BPF`æŒ‡ä»¤ï¼›
-   `BPF`çš„`API`ï¼›
-   `BPF`çš„é™åˆ¶ï¼›
-   ä»¥åŠ`BTF`ï¼ˆ`BPF Type Format`ï¼‰çš„ä½œç”¨ã€‚

è¿™äº›å†…å®¹ä¸ºç†è§£`bpftrace`ä¸`BCC`åœ¨èƒŒåæ˜¯å¦‚ä½•è¿ä½œçš„å¥ å®šåŸºç¡€ã€‚

###### ğŸƒ ä¸ºä»€ä¹ˆæ€§èƒ½åˆ†æå·¥å…·éœ€è¦`BPF`

æ€§èƒ½åˆ†æå·¥å…·ä¹‹æ‰€ä»¥ä½¿ç”¨æ‰©å±•`BPF`ï¼ˆ`eBPF`ï¼‰ï¼Œéƒ¨åˆ†åŸå› åœ¨äºå…¶**å¯ç¼–ç¨‹æ€§**ã€‚å€ŸåŠ©`BPF`ç¨‹åºï¼Œå¯ä»¥æ‰§è¡Œè‡ªå®šä¹‰çš„å»¶è¿Ÿè®¡ç®—å’Œç»Ÿè®¡æ±‡æ€»ã€‚è¿™äº›ç‰¹æ€§æœ¬èº«å°±è¶³ä»¥æ‰“é€ ä¸€ä¸ªéå¸¸å¼ºå¤§çš„å·¥å…·ï¼Œäº‹å®ä¸Šï¼Œè®¸å¤šç°æœ‰çš„è·Ÿè¸ªå·¥å…·ä¹Ÿå…·å¤‡ç±»ä¼¼åŠŸèƒ½ã€‚

ä½†**BPFçš„ç‹¬ç‰¹ä¹‹å¤„**åœ¨äºï¼šå®ƒä¸ä»…åŠŸèƒ½å¼ºå¤§ï¼Œè¿˜å…·æœ‰**é«˜æ•ˆæ€§ä¸ç”Ÿäº§ç¯å¢ƒçš„å®‰å…¨æ€§**ï¼Œè€Œä¸”æ˜¯**å†…å»ºäºLinuxå†…æ ¸**ä¹‹ä¸­çš„ã€‚è¿™æ„å‘³ç€æˆ‘ä»¬å¯ä»¥**åœ¨ç”Ÿäº§ç³»ç»Ÿä¸­ç›´æ¥è¿è¡Œè¿™äº›å·¥å…·**ï¼Œè€Œæ— éœ€å¼•å…¥é¢å¤–çš„å†…æ ¸æ¨¡å—æˆ–ç»„ä»¶ã€‚

ä¸‹é¢æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªè¾“å‡ºç¤ºä¾‹å’Œç¤ºæ„å›¾ï¼Œäº†è§£æ€§èƒ½å·¥å…·æ˜¯å¦‚ä½•åˆ©ç”¨`BPF`çš„ã€‚è¿™ä¸ªä¾‹å­æ¥è‡ªæˆ‘æ—©æœŸå‘å¸ƒçš„ä¸€ä¸ª`BPF`å·¥å…·â€”â€”`bitehist`ï¼Œå®ƒå°†ç£ç›˜`I/O`çš„æ•°æ®å¤§å°ä»¥ç›´æ–¹å›¾å½¢å¼å±•ç¤ºã€‚

```bash
# bitehist
Tracing block device I/O... Interval 5 secs. Ctrl-C to end.
kbytes 				: count 			distribution
0    -> 1 		: 3 					| 																			|
2   -> 3 			: 0 					| 																			|
4   -> 7 			: 3395 				|************************************* 	|
8   -> 15 		: 1 					| 																			|
16  -> 31 		: 2 					| 																			|
32  -> 63 		: 738 				|******* 																|
64  -> 127 		: 3 					| 																			|
128 -> 255 		:	1 					| 																			|
```

å›¾2-4å±•ç¤ºäº†`BPF`æ˜¯å¦‚ä½•æå‡è¯¥å·¥å…·æ•ˆç‡çš„ã€‚

![](/assets/img/linux/bpf/figure2-4.png)

å›¾2-4ä½¿ç”¨`BPF`å‰åçš„ç›´æ–¹å›¾ç”Ÿæˆæ–¹å¼å¯¹æ¯”

å…³é”®çš„æ”¹å˜åœ¨äºï¼š**è¿™ä¸ªç›´æ–¹å›¾æ˜¯åœ¨å†…æ ¸ä¸Šä¸‹æ–‡ä¸­ç”Ÿæˆçš„**ï¼Œä»è€Œå¤§å¤§å‡å°‘äº†éœ€è¦å¤åˆ¶åˆ°ç”¨æˆ·æ€çš„æ•°æ®é‡ã€‚è¿™ç§æ•ˆç‡çš„æå‡éå¸¸æ˜¾è‘—ï¼Œä½¿å¾—åŸæœ¬å› ä»£ä»·è¿‡é«˜æ— æ³•åœ¨ç”Ÿäº§ä¸­ä½¿ç”¨çš„å·¥å…·å˜å¾—å¯è¡Œã€‚

åœ¨ä½¿ç”¨`BPF`ä¹‹å‰ï¼Œç”Ÿæˆè¿™æ ·çš„ç›´æ–¹å›¾éœ€è¦ä»¥ä¸‹æ­¥éª¤ï¼š

1.  **åœ¨å†…æ ¸ä¸­**ï¼šå¯ç”¨å¯¹ç£ç›˜`I/O`äº‹ä»¶çš„è§‚æµ‹ï¼ˆ`instrumentation`ï¼‰ã€‚
2.  **æ¯æ¬¡äº‹ä»¶å‘ç”Ÿæ—¶**ï¼šå‘`perf`ç¼“å†²åŒºå†™å…¥ä¸€æ¡è®°å½•ã€‚å¦‚æœä½¿ç”¨`tracepoint`ï¼ˆæ¨èçš„æ–¹å¼ï¼‰ï¼Œè®°å½•ä¼šåŒ…å«å¤šä¸ªå­—æ®µçš„å…ƒæ•°æ®ã€‚
3.  **åœ¨ç”¨æˆ·ç©ºé—´**ï¼šå®šæœŸå°†æ•´ä¸ª`perf`ç¼“å†²åŒºå¤åˆ¶åˆ°ç”¨æˆ·ç©ºé—´ã€‚
4.  **åœ¨ç”¨æˆ·ç©ºé—´**ï¼šéå†æ‰€æœ‰äº‹ä»¶ï¼Œåªè§£æå…¶ä¸­çš„`bytes`å­—æ®µï¼Œå…¶å®ƒå­—æ®µä¼šè¢«å¿½ç•¥ã€‚
5.  **åœ¨ç”¨æˆ·ç©ºé—´**ï¼šå¯¹`bytes`å­—æ®µç”Ÿæˆç›´æ–¹å›¾æ±‡æ€»ã€‚

å¯¹äº`I/O`å‹åŠ›è¾ƒå¤§çš„ç³»ç»Ÿæ¥è¯´ï¼Œç¬¬2è‡³ç¬¬4æ­¥ä¼šå¸¦æ¥**è¾ƒé«˜çš„æ€§èƒ½å¼€é”€**ã€‚è®¾æƒ³æ¯ç§’ä¼ è¾“10,000æ¡ç£ç›˜`I/O`è·Ÿè¸ªè®°å½•åˆ°ç”¨æˆ·ç©ºé—´å¹¶é€æ¡è§£æï¼Œå¼€é”€æ˜¯æå…¶å·¨å¤§çš„ã€‚

ä½¿ç”¨`BPF`åçš„ä¼˜åŒ–æµç¨‹ï¼š

1.  **åœ¨å†…æ ¸ä¸­**ï¼šå¯ç”¨ç£ç›˜`I/O`äº‹ä»¶ï¼Œå¹¶é™„åŠ ä¸€ä¸ªç”±`bitesize`å®šä¹‰çš„è‡ªå®šä¹‰`BPF`ç¨‹åºã€‚
2.  **æ¯æ¬¡äº‹ä»¶å‘ç”Ÿæ—¶**ï¼š`BPF`ç¨‹åºåœ¨å†…æ ¸ä¸­è¿è¡Œï¼Œä»…æå–`bytes`å­—æ®µï¼Œå¹¶å°†å…¶å†™å…¥è‡ªå®šä¹‰çš„`BPF`æ˜ å°„ï¼ˆ`map`ï¼‰ä½œä¸ºç›´æ–¹å›¾æ•°æ®ç»“æ„ã€‚
3.  **åœ¨ç”¨æˆ·ç©ºé—´**ï¼šåªéœ€ä¸€æ¬¡æ€§è¯»å–`BPF`æ˜ å°„ä¸­çš„ç›´æ–¹å›¾æ•°æ®å¹¶è¾“å‡ºå³å¯ã€‚

è¿™ç§æ–¹æ³•å®Œå…¨é¿å…äº†å°†äº‹ä»¶é€æ¡å¤åˆ¶åˆ°ç”¨æˆ·ç©ºé—´å¹¶é‡æ–°å¤„ç†çš„é«˜æ˜‚ä»£ä»·ã€‚åŒæ—¶ï¼Œä¹Ÿé¿å…äº†å¤åˆ¶é‚£äº›ä¸è¢«ä½¿ç”¨çš„å…ƒæ•°æ®å­—æ®µã€‚æœ€ç»ˆï¼Œ**å”¯ä¸€å¤åˆ¶åˆ°ç”¨æˆ·ç©ºé—´çš„æ•°æ®å°±æ˜¯ç›´æ–¹å›¾ä¸­çš„â€œè®¡æ•°åˆ—â€ï¼ˆcount columnï¼‰ï¼Œå³ä¸€ç»„æ•°å­—æ•°ç»„**ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬åœ¨å·¥å…·è¾“å‡ºä¸­çœ‹åˆ°çš„å†…å®¹ã€‚

###### ğŸƒ `BPF`ä¸å†…æ ¸æ¨¡å—çš„å¯¹æ¯”

ç†è§£`BPF`åœ¨å¯è§‚æµ‹æ€§ï¼ˆ`observability`ï¼‰æ–¹é¢çš„ä¼˜åŠ¿ï¼Œè¿˜æœ‰ä¸€ç§æ–¹æ³•æ˜¯å°†å®ƒä¸å†…æ ¸æ¨¡å—è¿›è¡Œå¯¹æ¯”ã€‚äº‹å®ä¸Šï¼Œ`kprobes`å’Œ`tracepoints`æ—©å·²åœ¨å†…æ ¸ä¸­å­˜åœ¨å¤šå¹´ï¼Œå®ƒä»¬å¯ä»¥ç›´æ¥é€šè¿‡å¯åŠ è½½å†…æ ¸æ¨¡å—ï¼ˆ`LKM`ï¼‰æ¥ä½¿ç”¨ã€‚ä½†ç›¸æ¯”ä¹‹ä¸‹ï¼Œ`BPF`åœ¨è¿½è¸ªåˆ†æä¸­çš„ä¼˜åŠ¿åŒ…æ‹¬ï¼š

-   **å®‰å…¨æ€§æ›´é«˜**ï¼š`BPF`ç¨‹åºä¼šç»è¿‡`verifier`éªŒè¯å™¨çš„æ£€æŸ¥ï¼Œè€Œå†…æ ¸æ¨¡å—å¯èƒ½å¼•å…¥å†…æ ¸å´©æºƒï¼ˆ`kernel panic`ï¼‰æˆ–å®‰å…¨æ¼æ´ã€‚

-   **æ”¯æŒä¸°å¯Œçš„æ•°æ®ç»“æ„**ï¼š`BPF`æä¾›äº†ç»“æ„åŒ–çš„`map`æ•°æ®ç»“æ„ï¼Œä¾¿äºå­˜å‚¨ä¸ä¼ é€’è§‚æµ‹æ•°æ®ã€‚

-   **è‰¯å¥½çš„å¯ç§»æ¤æ€§**ï¼š`BPF`ç¨‹åºå¯ä»¥ä¸€æ¬¡ç¼–è¯‘ï¼Œåˆ°å¤„è¿è¡Œã€‚å› ä¸º`BPF`çš„æŒ‡ä»¤é›†ã€`map`ã€`helper`å‡½æ•°å’Œè¿è¡Œç¯å¢ƒæ„æˆäº†ä¸€ä¸ªç¨³å®šçš„ `ABI`ï¼ˆåº”ç”¨äºŒè¿›åˆ¶æ¥å£ï¼‰ã€‚

    >   ï¼ˆä¸è¿‡ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæœ‰äº›`BPF`è·Ÿè¸ªç¨‹åºä»ä¾èµ–äºä¸ç¨³å®šçš„éƒ¨åˆ†ï¼Œæ¯”å¦‚åŸºäºå†…æ ¸ç»“æ„ä½“çš„`kprobe`ï¼Œç¬¬2.3.10èŠ‚ä¼šä»‹ç»ç›¸å…³è§£å†³æ–¹æ¡ˆã€‚ï¼‰

-   **æ— éœ€ä¾èµ–å†…æ ¸æºç æˆ–æ„å»ºäº§ç‰©**ï¼š`BPF`ç¨‹åºç¼–è¯‘æ—¶ä¸éœ€è¦å†…æ ¸æ„å»ºç¯å¢ƒï¼Œé™ä½äº†ä½¿ç”¨é—¨æ§›ã€‚

-   **å­¦ä¹ æˆæœ¬ä½**ï¼š`BPF`ç¼–ç¨‹æ¯”ç¼–å†™å†…æ ¸æ¨¡å—æ›´å®¹æ˜“æŒæ¡ï¼Œä¸éœ€è¦æ·±åšçš„å†…æ ¸å¼€å‘ç»éªŒï¼Œå› æ­¤å¯¹æ›´å¤šå¼€å‘è€…å‹å¥½ã€‚

æ­¤å¤–ï¼Œ`BPF`åœ¨ç½‘ç»œæ–¹é¢è¿˜å…·å¤‡æ›´å¤šä¼˜åŠ¿ï¼Œæ¯”å¦‚æ”¯æŒ**åŸå­æ€§æ›¿æ¢**ï¼ˆ`atomic replacement`ï¼‰`BPF`ç¨‹åºã€‚ç›¸æ¯”ä¹‹ä¸‹ï¼Œå†…æ ¸æ¨¡å—æƒ³è¦å‡çº§ä»£ç ï¼Œéœ€è¦å…ˆå¸è½½æ—§æ¨¡å—å†é‡æ–°åŠ è½½æ–°æ¨¡å—ï¼Œè¿™ä¸ªè¿‡ç¨‹å¯èƒ½ä¼šä¸­æ–­æœåŠ¡ã€‚

å½“ç„¶ï¼Œå†…æ ¸æ¨¡å—çš„ä¸€ä¸ªä¼˜åŠ¿åœ¨äºå®ƒèƒ½è®¿é—®å…¶ä»–å†…æ ¸å‡½æ•°ä¸åŠŸèƒ½ï¼Œä¸å—é™äº`BPF helper`è°ƒç”¨ã€‚ä½†è¿™ç§çµæ´»æ€§ä¹Ÿä¼´éšç€é£é™©ï¼šå¦‚æœè°ƒç”¨äº†ä¸å½“çš„å†…æ ¸å‡½æ•°ï¼Œå®¹æ˜“å¼•å…¥ç³»ç»Ÿçº§åˆ«çš„`bug`ã€‚

###### ğŸƒ ç¼–å†™`BPF`ç¨‹åº

`BPF`æ”¯æŒå¤šç§å‰ç«¯å·¥å…·æ¥è¿›è¡Œç¼–ç¨‹ã€‚é’ˆå¯¹è¿½è¸ªç”¨é€”ï¼Œå¸¸è§çš„ä»ä½åˆ°é«˜å±‚æ¬¡çš„ç¼–ç¨‹æ–¹å¼åŒ…æ‹¬ï¼š

-   `LLVM`
-   `BCC`
-   `bpftrace`

`LLVM`ç¼–è¯‘å™¨æ”¯æŒå°†ç¨‹åºç¼–è¯‘ä¸º`BPF`æŒ‡ä»¤ã€‚å¼€å‘è€…å¯ä»¥ä½¿ç”¨`LLVM`æ”¯æŒçš„é«˜çº§è¯­è¨€ï¼ˆå¦‚`C`ï¼Œé€šè¿‡`Clang`ç¼–è¯‘ï¼‰æˆ–`LLVM`ä¸­é—´è¡¨ç¤ºï¼ˆ`IR`ï¼‰æ¥ç¼–å†™`BPF`ç¨‹åºï¼Œç„¶åç¼–è¯‘ç”Ÿæˆ`BPF`å­—èŠ‚ç ã€‚`LLVM`ç¼–è¯‘å™¨è¿˜å¸¦æœ‰ä¼˜åŒ–å™¨ï¼Œå¯æå‡ç”Ÿæˆçš„`BPF`ç¨‹åºçš„æ•ˆç‡å’Œç´§å‡‘æ€§ã€‚

å°½ç®¡ç›´æ¥ç”¨`LLVM IR`ç¼–å†™`BPF`ç¨‹åºå·²ç»æ˜¯ä¸€ç§è¿›æ­¥ï¼Œä½†æ›´æ¨èä½¿ç”¨æ›´é«˜çº§çš„å·¥å…·å¦‚`BCC`æˆ–`bpftrace`ï¼š

-   `BCC`å…è®¸ä½¿ç”¨`C`è¯­è¨€æ¥ç¼–å†™`BPF`ç¨‹åºï¼›
-   `bpftrace`åˆ™æä¾›äº†ä¸€ç§ä¸“ç”¨çš„é«˜çº§è„šæœ¬è¯­è¨€ã€‚

è¿™ä¸¤è€…åœ¨å†…éƒ¨ä»ç„¶ä¾èµ–`LLVM IR`åŠå…¶ç¼–è¯‘åº“å°†ä»£ç ç¼–è¯‘ä¸º`BPF`å­—èŠ‚ç ã€‚

æœ¬ä¹¦æ‰€ä»‹ç»çš„æ€§èƒ½åˆ†æå·¥å…·ï¼Œä¸»è¦åŸºäº`BCC`å’Œ`bpftrace`å¼€å‘ã€‚ç›´æ¥ä½¿ç”¨`BPF`æŒ‡ä»¤æˆ–`LLVM IR`è¿›è¡Œç¼–ç¨‹ï¼Œä¸€èˆ¬æ˜¯`BCC`å’Œ`bpftrace`å¼€å‘è€…çš„å·¥ä½œèŒƒç•´ï¼Œè¶…å‡ºäº†æœ¬ä¹¦çš„è®¨è®ºèŒƒå›´ã€‚
å¯¹äºæˆ‘ä»¬è¿™äº›ä½¿ç”¨å’Œå¼€å‘`BPF`æ€§èƒ½å·¥å…·çš„äººè€Œè¨€ï¼Œäº†è§£åº•å±‚`BPF`æŒ‡ä»¤å¹¶éå¿…è¦ã€‚

ä¸è¿‡ï¼Œå¦‚æœä½ æƒ³æ·±å…¥æˆä¸º`BPF`å­—èŠ‚ç å¼€å‘è€…ï¼Œæˆ–å¯¹åº•å±‚å®ç°æ„Ÿå…´è¶£ï¼Œå¯ä»¥å‚è€ƒä»¥ä¸‹èµ„æ–™ï¼š

-   é™„å½•`E`ç®€è¦ä»‹ç»äº†`BPF`çš„æŒ‡ä»¤é›†å’Œå®ã€‚
-   `Linux`å†…æ ¸æºç æ ‘ä¸­çš„æ–‡æ¡£`Documentation/networking/filter.txt`æä¾›äº†`BPF`æŒ‡ä»¤çš„è¯¦ç»†è¯´æ˜ã€‚
-   `LLVM IR`å¯é€šè¿‡`LLVM`å®˜ç½‘çš„`llvm::IRBuilderBase`ç±»å‚è€ƒæ–‡æ¡£ è¿›è¡Œå­¦ä¹ ã€‚
-   `Cilium`çš„`BPF`ä¸`XDP`å‚è€ƒæŒ‡å—ä¹Ÿæä¾›äº†ä¸°å¯Œçš„å®è·µèµ„æ–™ã€‚

å°½ç®¡æˆ‘ä»¬å¤§å¤šæ•°äººä¸ä¼šç›´æ¥ç¼–å†™`BPF`æŒ‡ä»¤ï¼Œä½†åœ¨æ’æŸ¥å·¥å…·é—®é¢˜æ—¶ï¼Œæˆ‘ä»¬å¸¸å¸¸ä¼šæŸ¥çœ‹è¿™äº›åº•å±‚å†…å®¹ã€‚æ¥ä¸‹æ¥çš„ä¸¤ä¸ªå°èŠ‚å°†å±•ç¤ºå¦‚ä½•ä½¿ç”¨`bpftool(8)`å’Œ`bpftrace`æ¥æŸ¥çœ‹å’Œè°ƒè¯•`BPF`ç¨‹åºã€‚

###### ğŸƒ æŸ¥çœ‹`BPF`æŒ‡ä»¤ï¼š`bpftool`

`bpftool(8)`æ˜¯ä»`Linux 4.15`å¼€å§‹å¼•å…¥çš„å·¥å…·ï¼Œç”¨äº**æŸ¥çœ‹å’Œæ“ä½œBPFå¯¹è±¡**ï¼ŒåŒ…æ‹¬ç¨‹åºï¼ˆ`program`ï¼‰å’Œæ˜ å°„ï¼ˆ`map`ï¼‰ã€‚è¯¥å·¥å…·çš„æºç ä½äº`Linux`å†…æ ¸æºç æ ‘çš„`tools/bpf/bpftool`ç›®å½•ä¸‹ã€‚

æœ¬èŠ‚å°†ç®€è¦ä»‹ç»å¦‚ä½•ä½¿ç”¨`bpftool(8)`æ¥**æŸ¥æ‰¾å·²åŠ è½½çš„BPFç¨‹åº**å¹¶**æ‰“å°å…¶æŒ‡ä»¤å†…å®¹**ã€‚

è¿è¡Œ`bpftool`å‘½ä»¤åï¼Œå¦‚æœä¸å¸¦å‚æ•°ï¼Œå®ƒä¼šæ˜¾ç¤ºå®ƒæ‰€æ”¯æŒæ“ä½œçš„å¯¹è±¡ç±»å‹ã€‚ä»`Linux 5.2`èµ·ï¼Œå…¶é»˜è®¤è¾“å‡ºå¦‚ä¸‹ï¼š

```bash
$ bpftool
Usage: bpftool [OPTIONS] OBJECT { COMMAND | help }
       bpftool batch file FILE
       bpftool version

       OBJECT := { prog | map | link | cgroup | perf | net | feature | btf | gen | struct_ops | iter }
       OPTIONS := { {-j|--json} [{-p|--pretty}] | {-d|--debug} |
                    {-V|--version} }
```

æ¯ç§å¯¹è±¡ç±»å‹éƒ½æœ‰ç‹¬ç«‹çš„å¸®åŠ©é¡µé¢ã€‚ä¾‹å¦‚ï¼Œé’ˆå¯¹`BPF`ç¨‹åºçš„å¸®åŠ©ä¿¡æ¯ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼æŸ¥çœ‹ï¼š

```bash
$ bpftool prog help
Usage: bpftool prog { show | list } [PROG]
       bpftool prog dump xlated PROG [{ file FILE | [opcodes] [linum] [visual] }]
       bpftool prog dump jited  PROG [{ file FILE | [opcodes] [linum] }]
       bpftool prog pin   PROG FILE
       bpftool prog { load | loadall } OBJ  PATH \
                         [type TYPE] [{ offload_dev | xdpmeta_dev } NAME] \
                         [map { idx IDX | name NAME } MAP]\
                         [pinmaps MAP_DIR]
                         [autoattach]
       bpftool prog attach PROG ATTACH_TYPE [MAP]
       bpftool prog detach PROG ATTACH_TYPE [MAP]
       bpftool prog run PROG \
                         data_in FILE \
                         [data_out FILE [data_size_out L]] \
                         [ctx_in FILE [ctx_out FILE [ctx_size_out M]]] \
                         [repeat N]
       bpftool prog profile PROG [duration DURATION] METRICs
       bpftool prog tracelog
       bpftool prog help

       MAP := { id MAP_ID | pinned FILE | name MAP_NAME }
       PROG := { id PROG_ID | pinned FILE | tag PROG_TAG | name PROG_NAME }
       TYPE := { socket | kprobe | kretprobe | classifier | action |
                 tracepoint | raw_tracepoint | xdp | perf_event | cgroup/skb |
                 cgroup/sock | cgroup/dev | lwt_in | lwt_out | lwt_xmit |
                 lwt_seg6local | sockops | sk_skb | sk_msg | lirc_mode2 |
                 sk_reuseport | flow_dissector | cgroup/sysctl |
                 cgroup/bind4 | cgroup/bind6 | cgroup/post_bind4 |
                 cgroup/post_bind6 | cgroup/connect4 | cgroup/connect6 |
                 cgroup/connect_unix | cgroup/getpeername4 | cgroup/getpeername6 |
                 cgroup/getpeername_unix | cgroup/getsockname4 | cgroup/getsockname6 |
                 cgroup/getsockname_unix | cgroup/sendmsg4 | cgroup/sendmsg6 |
                 cgroup/sendmsgÂ°unix | cgroup/recvmsg4 | cgroup/recvmsg6 | cgroup/recvmsg_unix |
                 cgroup/getsockopt | cgroup/setsockopt | cgroup/sock_release |
                 struct_ops | fentry | fexit | freplace | sk_lookup }
       ATTACH_TYPE := { sk_msg_verdict | sk_skb_verdict | sk_skb_stream_verdict |
                        sk_skb_stream_parser | flow_dissector }
       METRIC := { cycles | instructions | l1d_loads | llc_misses | itlb_misses | dtlb_misses }
       OPTIONS := { {-j|--json} [{-p|--pretty}] | {-d|--debug} |
                    {-f|--bpffs} | {-m|--mapcompat} | {-n|--nomount} |
                    {-L|--use-loader} }
```

`perf`å’Œ`prog`å­å‘½ä»¤å¯ç”¨äº**æŸ¥æ‰¾å¹¶æ‰“å°tracingç±»å‹çš„BPFç¨‹åº**ã€‚æœ¬èŠ‚æœªæ¶µç›–çš„`bpftool(8)`åŠŸèƒ½è¿˜åŒ…æ‹¬ï¼š**é™„åŠ ç¨‹åºã€è¯»å†™mapã€æ“ä½œcgroupï¼Œä»¥åŠåˆ—å‡ºBPFæ”¯æŒç‰¹æ€§**ç­‰ã€‚

**bpftool perf**

`perf`å­å‘½ä»¤ç”¨äºæ˜¾ç¤ºé€šè¿‡`perf_event_open()`æ¥å£é™„åŠ çš„`BPF`ç¨‹åºã€‚è¿™æ˜¯**BCCå’Œbpftraceç¨‹åº** åœ¨`Linux 4.17`åŠæ›´é«˜ç‰ˆæœ¬ä¸­ä½¿ç”¨çš„å¸¸è§æ–¹å¼ã€‚

ä¾‹å¦‚ï¼š

```bash
# bpftool perf
pid 1765 fd 6: prog_id 26 kprobe func blk_account_io_start offset 0
pid 1765 fd 8: prog_id 27 kprobe func blk_account_io_done offset 0
pid 1765 fd 11: prog_id 28 kprobe func sched_fork offset 0
pid 1765 fd 15: prog_id 29 kprobe func ttwu_do_wakeup offset 0
pid 1765 fd 17: prog_id 30 kprobe func wake_up_new_task offset 0
pid 1765 fd 19: prog_id 31 kprobe func finish_task_switch offset 0
pid 1765 fd 26: prog_id 33 tracepoint inet_sock_set_state
pid 21993 fd 6: prog_id 232 uprobe filename /proc/self/exe offset 1781927
pid 21993 fd 8: prog_id 233 uprobe filename /proc/self/exe offset 1781920
pid 21993 fd 15: prog_id 234 kprobe func blk_account_io_done offset 0
pid 21993 fd 17: prog_id 235 kprobe func blk_account_io_start offset 0
pid 25440 fd 8: prog_id 262 kprobe func blk_mq_start_request offset 0
pid 25440 fd 10: prog_id 263 kprobe func blk_account_io_done offset 0
```

è¯¥è¾“å‡ºå±•ç¤ºäº†ä¸‰ä¸ªä¸åŒçš„è¿›ç¨‹ï¼ˆ`PID`ï¼‰åŠå…¶å¯¹åº”çš„å¤šç§`BPF`ç¨‹åºï¼š

-   **PID 1765**æ˜¯ä¸€ä¸ªç”¨äºå®ä¾‹åˆ†æçš„`Vector BPF PMDA`ä»£ç†ã€‚
-   **PID 21993**æ˜¯`bpftrace`ç‰ˆæœ¬çš„`biolatency(8)`ï¼Œæ˜¾ç¤ºäº†ä¸¤ä¸ª uprobesï¼ˆç”¨æˆ·æ€æ¢é’ˆï¼‰ï¼Œåˆ†åˆ«å¯¹åº” `bpftrace` ç¨‹åºä¸­çš„ BEGIN å’Œ END æ¢é’ˆï¼Œä»¥åŠä¸¤ä¸ª kprobesï¼ˆå†…æ ¸æ€æ¢é’ˆï¼‰ï¼Œç”¨äºç›‘æ§å—è®¾å¤‡ I/O çš„å¼€å§‹å’Œç»“æŸã€‚ï¼ˆè¯¥ç¨‹åºæºç è¯¦è§ç¬¬9ç« ï¼‰
-   **PID 25440** æ˜¯ BCC ç‰ˆæœ¬çš„ `biolatency(8)`ï¼Œå®ƒç›®å‰ç›‘æ§çš„æ˜¯å—è®¾å¤‡ I/O çš„å¦ä¸€ä¸ªèµ·å§‹å‡½æ•°ã€‚

å…¶ä¸­ï¼Œ`offset` å­—æ®µè¡¨ç¤ºæ¢é’ˆç›¸å¯¹äºè¢«ç›‘æ§å¯¹è±¡çš„åç§»ä½ç½®ã€‚
 ä»¥ `bpftrace` ä¸ºä¾‹ï¼Œåç§» `1781920` å¯¹åº”äº `bpftrace` å¯æ‰§è¡Œæ–‡ä»¶ä¸­çš„ `BEGIN_trigger` å‡½æ•°ï¼Œåç§» `1781927` å¯¹åº”äº `END_trigger` å‡½æ•°ï¼ˆå¯ä»¥é€šè¿‡å‘½ä»¤ `readelf -s bpftrace` è¿›è¡ŒéªŒè¯ï¼‰ã€‚

`prog_id` æ˜¯ BPF ç¨‹åºçš„å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹å­å‘½ä»¤æ‰“å°å‡ºæ¥ã€‚



## ğŸ“Œ å°ç»“å¯¹æ¯”ï¼š

| å¯¹æ¯”ç‚¹       | bpftrace                        | bpftool                      |
| ------------ | ------------------------------- | ---------------------------- |
| ç±»å‹         | åŠ¨æ€è„šæœ¬è¯­è¨€ + ç¼–è¯‘å™¨           | å‘½ä»¤è¡Œå·¥å…·                   |
| ç›®çš„         | ç¼–å†™ã€ç¼–è¯‘ã€è¿è¡Œ BPF trace è„šæœ¬ | ç®¡ç†ã€è°ƒè¯•ã€ç›‘æ§ BPF ç¨‹åº    |
| ç¼–è¯‘å¼•æ“     | ä½¿ç”¨ LLVMï¼ˆç”Ÿæˆå­—èŠ‚ç ï¼‰         | ä¸ç”Ÿæˆ bpftrace è„šæœ¬çš„å­—èŠ‚ç  |
| æ˜¯å¦ä¾èµ–å½¼æ­¤ | âŒ æ— ç›´æ¥ä¾èµ–                    | âŒ ä¸ä¸ bpftrace äº¤äº’         |